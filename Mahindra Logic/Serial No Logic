using System;
using System.Data;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Web;
using System.Data.Entity;
using System.Web.Mvc;
using Mahindra_AD.Helper;
using System.Text.RegularExpressions;
using Mahindra_AD.Controllers.OrderManagement;
using Mahindra_AD.Utility;
using System.Configuration;
using System.Data.SqlClient;

namespace Mahindra_AD.Models
{

    [MetadataType(typeof(MetaOrderStart))]
    public partial class MM_OM_Order_List
    {
        private DRONA_NGPEntities db = new DRONA_NGPEntities();
        public static string connectionstring = ConfigurationManager.ConnectionStrings["ADONET"].ConnectionString;
        public static SqlConnection con = new SqlConnection(connectionstring);
        //  private DRONA_NGPEntities db = new DRONA_NGPEntities();
        /*               Action Name               : getPSNByDate
         *               Description               : Funcion used to genrating date wise the PSN number in order start form. 
         *               Author, Timestamp         : Rahul Varpe
         *               Input parameter           : None
         *               Return Type               : int
         *               Revision                  : 1
         */
        public String oldSeriesCode = "";
        //public string Ipms_Serial_No { get; set; }
        public int getPSNByDate(int ShopId, int LineId)
        {
            try
            {
                DateTime time = DateTime.Now;             // Use current time.
                string format = "MM-dd-yy";   // Use this format.
                string dtObj = time.ToString(format);

                // String query = "select * from MM_OM_Order_List where CONVERT(VARCHAR(10),Inserted_Date,10)='" + dtObj + "'";
                String query = "SELECT MAX(PSN) FROM MM_OM_Order_List WHERE Shop_Id='" + Shop_ID + "' and Line_Id='" + Line_ID + "'";
                IEnumerable<MM_OM_Order_List> totalStarted = db.Database.SqlQuery<MM_OM_Order_List>(query);

                return totalStarted.Count();
            }
            catch (Exception)
            {
                return 0;
            }
        }

        /*               Action Name               : getDSNByDateShop
     *               Description               : Funcion used to genrating date wise the DSN number in order start form. 
     *               Author, Timestamp         : Rahul Varpe
     *               Input parameter           : None
     *               Return Type               : int
     *               Revision                  : 1
     */
        public int getDSNByDateShop(int shopId, int lineId)
        {
            try
            {
                DateTime time = DateTime.Now;             // Use current time.
                string format = "MM-dd-yy";   // Use this format.
                string dtObj = time.ToString(format);

                //String query = "select * from MM_OM_Order_List where CONVERT(VARCHAR(10),Inserted_Date,10)='" + dtObj + "' and Shop_ID='" + shopId + "' and Line_ID='" + lineId + "'";
                String query = "select * from MM_OM_Order_List where CONVERT(VARCHAR(10),Inserted_Date,10)='" + dtObj + "' and Shop_ID='" + shopId + "'";
                IEnumerable<MM_OM_Order_List> totalStarted = db.Database.SqlQuery<MM_OM_Order_List>(query);

                return totalStarted.Count();
            }
            catch (Exception)
            {
                return 0;
            }
        }

        /*               Action Name               : getSerialNumber
         *               Description               : Funcion used to genrating the Serial Number in order start form. 
         *               Author, Timestamp         : Rahul Varpe
         *               Input parameter           : totalOrderReleased,orderNo
         *               Return Type               : string
         *               Revision                  : 1
         */
        public String getSerialNumber(int shopId, int lineId, int totalOrderReleased, String orderNo, String modelCode, String partno, decimal? series_code, int serial_Config)
        {
            try
            {
                MM_Partgroup partGroupObj = db.MM_Partgroup.Where(a => a.Line_ID == lineId).FirstOrDefault();
                if ((shopId == 2 || shopId == 3 || shopId == 1 || shopId == 4) && partGroupObj.Order_Create == true)
                {
                    String number = "";
                    String serialNo = "";
                    MM_Serial_Number_Configuration mm_serialNumberConfig;
                    MM_Lines mm_line;

                    mm_line = (from mm_line_data in db.MM_Lines
                               where mm_line_data.Line_ID == lineId
                               select mm_line_data).FirstOrDefault();

                    //IF PARTNO DOES NOT EXIST IN MODEL MASTER
                    var modelMast = db.MM_Model_Master.Where(a => a.Model_Code == partno).FirstOrDefault();
                    if (modelMast != null)
                    {
                        serial_Config = Convert.ToInt32(modelMast.Config_ID);
                    }

                    mm_serialNumberConfig = (from mm_serialNumber in db.MM_Serial_Number_Configuration
                                             where mm_serialNumber.Config_ID == serial_Config
                                             select mm_serialNumber
                                             ).FirstOrDefault();

                    if (mm_serialNumberConfig != null)
                    {
                        MM_Serial_Number_Data mm_SerialNumberData;
                        mm_SerialNumberData = (from mm_serialNumberData in db.MM_Serial_Number_Data
                                               where mm_serialNumberData.Part_No.Trim() == partno.Trim()
                                               select mm_serialNumberData
                                               ).FirstOrDefault();

                        if (mm_SerialNumberData != null)
                        {
                            string serial_logic = "";
                            serial_logic = mm_serialNumberConfig.Serial_Logic;

                            string[] thisArray = serial_logic.Split(',');//<string1/string2/string3/--->     
                            List<string> myList = new List<string>(); //make a new string list    
                            myList.AddRange(thisArray);

                            for (int i = 0; i < myList.Count(); i++)
                            {
                                var names = typeof(MM_Serial_Number_Data).GetProperties()
                                            .Select(property => property.Name)
                                            .ToArray();

                                for (int j = 0; j < names.Count(); j++)
                                {
                                    if (myList[i].ToString() == names[j].ToString())
                                    {
                                        string str = "Select " + myList[i].ToString() + " from MM_Serial_Number_Data where Part_No = '" + partno + "'";
                                        IEnumerable<String> query = db.Database.SqlQuery<String>(str).ToList();

                                        string val = query.FirstOrDefault();

                                        if ((myList[i].ToString().ToUpper()).Contains("YEAR"))
                                        {
                                            int currentYear = DateTime.Now.Year;
                                            int identifier = mm_serialNumberConfig.Year_Identifier.GetValueOrDefault(0);
                                            val = db.MM_Year.Where(a => a.Identifier_ID == identifier && a.Year == currentYear).FirstOrDefault().Year_Code.Trim();

                                        }
                                        else if ((myList[i].ToString().ToUpper()).Contains("MONTH"))
                                        {
                                            int currentMonth = Convert.ToInt32(DateTime.Now.ToString("MM"));
                                            int identifier = mm_serialNumberConfig.Month_Identifier.GetValueOrDefault(0);
                                            val = db.MM_Month.Where(a => a.Identifier_ID == identifier && a.Month_No == currentMonth).FirstOrDefault().Month_Code.Trim();
                                        }
                                        number = number + val;
                                    }
                                }
                            }
                            // String serialNo=orderNo.Substring(0,3);
                            serialNo = number;

                            string prefix = "";
                            string suffix = "";
                            if (!String.IsNullOrEmpty(mm_SerialNumberData.Prefix))
                            {
                                prefix = mm_SerialNumberData.Prefix;
                            }
                            if (!String.IsNullOrEmpty(mm_SerialNumberData.Suffix))
                            {
                                suffix = mm_SerialNumberData.Suffix;
                            }

                            General genObj = new General();

                            //int runningSerialCounter = genObj.getCurrentRunningSerial(partno);
                            int runningSerialCounter = 0;
                            serialNo = prefix.Trim().ToUpper() + (serialNo + Convert.ToString(runningSerialCounter).PadLeft(Convert.ToInt32(mm_serialNumberConfig.Series_Count), '0')).Trim() + suffix.Trim().ToUpper();

                        }
                        else
                        {
                            serialNo = (serialNo + "1".PadLeft(Convert.ToInt32(mm_serialNumberConfig.Series_Count), '0')).Trim();
                        }
                    }
                    else
                    {
                        serialNo = mm_line.Line_Code + orderNo;
                    }

                    return serialNo;
                }
                else
                {
                    String number = "";
                    String serialNo = "";
                    MM_Serial_Number_Configuration mm_serialNumberConfig;
                    MM_Lines mm_line;

                    mm_line = (from mm_line_data in db.MM_Lines
                               where mm_line_data.Line_ID == lineId
                               select mm_line_data).FirstOrDefault();

                    mm_serialNumberConfig = (from mm_serialNumber in db.MM_Serial_Number_Configuration
                                             where mm_serialNumber.Config_ID == serial_Config
                                             select mm_serialNumber
                                             ).FirstOrDefault();

                    if (mm_serialNumberConfig != null)
                    {
                        MM_Serial_Number_Data mm_SerialNumberData;
                        mm_SerialNumberData = (from mm_serialNumberData in db.MM_Serial_Number_Data
                                               where mm_serialNumberData.Part_No.Trim() == partno.Trim()
                                               select mm_serialNumberData
                                               ).FirstOrDefault();

                        if (mm_SerialNumberData != null)
                        {
                            string serial_logic = "";
                            serial_logic = mm_serialNumberConfig.Serial_Logic;

                            string[] thisArray = serial_logic.Split(',');//<string1/string2/string3/--->     
                            List<string> myList = new List<string>(); //make a new string list    
                            myList.AddRange(thisArray);

                            for (int i = 0; i < myList.Count(); i++)
                            {

                                var names = typeof(MM_Serial_Number_Data).GetProperties()
                                            .Select(property => property.Name)
                                            .ToArray();

                                for (int j = 0; j < names.Count(); j++)
                                {
                                    if (myList[i].ToString() == names[j].ToString())
                                    {
                                        string str = "Select " + myList[i].ToString() + " from MM_Serial_Number_Data where Part_No='" + partno + "'";
                                        IEnumerable<String> query = db.Database.SqlQuery<String>(str).ToList();

                                        string val = query.FirstOrDefault();
                                        if ((myList[i].ToString().ToUpper()).Contains("YEAR"))
                                        {
                                            int currentYear = DateTime.Now.Year;
                                            int identifier = mm_serialNumberConfig.Year_Identifier.GetValueOrDefault(0);
                                            val = db.MM_Year.Where(a => a.Identifier_ID == identifier && a.Year == currentYear).FirstOrDefault().Year_Code.Trim();
                                        }
                                        else if ((myList[i].ToString().ToUpper()).Contains("MONTH"))
                                        {
                                            int currentMonth = Convert.ToInt32(DateTime.Now.ToString("MM"));
                                            int identifier = mm_serialNumberConfig.Month_Identifier.GetValueOrDefault(0);
                                            val = db.MM_Month.Where(a => a.Identifier_ID == identifier && a.Month_No == currentMonth).FirstOrDefault().Month_Code.Trim();
                                        }
                                        number = number + val;
                                    }
                                }
                            }
                            // String serialNo=orderNo.Substring(0,3);
                            serialNo = number;

                            //find last 4 digit from order_list
                            var order_list = (from or_list in db.MM_OM_Order_List
                                              where or_list.Shop_ID == shopId && or_list.Line_ID == Line_ID
                                              select or_list).ToList();
                            if (order_list.Count() > 0)
                            {
                                var maxObject = order_list.OrderByDescending(item => item.PSN).First();
                                int psn = Convert.ToInt16(maxObject.PSN);
                                string serial = Convert.ToString(psn);
                                String strDigit = serial.TrimStart(new Char[] { '0' });
                                int lastDigit = Convert.ToInt16(strDigit) + 1;
                                //Count Zero
                                serialNo = (serialNo + Convert.ToString(lastDigit).PadLeft(Convert.ToInt32(mm_serialNumberConfig.Series_Count), '0')).Trim();
                            }
                            else
                            {
                                serialNo = serialNo + "1".PadLeft(Convert.ToInt32(mm_serialNumberConfig.Series_Count), '0').Trim();
                            }
                        }
                        else
                        {
                            serialNo = mm_line.Line_Code + orderNo;
                        }
                    }
                    else
                    {
                        serialNo = mm_line.Line_Code + orderNo;
                    }

                    return serialNo;
                }
            }
            catch (Exception ex)
            {
                return "";
            }
        }


        /*               Action Name               : Hold_Order_Check
         *               Description               : Funcion used the Hold_Order_check  in order start form. 
         *               Author, Timestamp         : Rahul Varpe
         *               Input parameter           : rowId,shopId,lineId,orderNo,modelCode,rsn
         *               Return Type               : Boolean
         *               Revision                  : 1
         */
        public Boolean Hold_Order_Check(int rowId, int shopId, int lineId, String orderNo, String modelCode, int rsn)
        {
            try
            {
                var st = (from orderReleaseItem in db.MM_OM_OrderRelease
                          where orderReleaseItem.Shop_ID == shopId && orderReleaseItem.Row_ID == rowId && orderReleaseItem.Order_Status == "Hold"
                          select orderReleaseItem).ToList();
                if (st.Count() > 0)
                {
                    return true;
                }
                else
                {
                    return false;
                }
            }
            catch (Exception)
            {

                return false;
            }

        }

        public Boolean Line_stop_or_not(int shopId, int lineId)
        {
            try
            {
                var st = (from line_stop in db.MM_Lines
                          where line_stop.Line_ID == lineId && line_stop.isLineStop == true
                          select line_stop
                          ).ToList();

                if (st.Count() > 0)
                {
                    return true;
                }
                else
                {
                    return false;
                }
            }
            catch (Exception)
            {

                return false;
            }

        }
        public string getSerialNumberAD(string ModelCode, int? runningSerialNumber, string order_No)
        {
            try
            {
                string serialNo = "";
                if (ModelCode != null)
                {
                    //var LineCode = (from model in db.MM_Model_Master.Where(m => m.Model_Code == ModelCode)
                    //                join line in db.MM_Lines
                    //                on model.Body_Line equals line.Line_ID
                    //                select new
                    //                {
                    //                    line.Line_Code
                    //                }).FirstOrDefault();
                    var LineCode = (from model in db.MM_Model_Master.Where(m => m.Model_Code == ModelCode)
                                    join line in db.MM_OM_Platform
                                    on model.Platform_Id equals line.Platform_ID
                                    //where model.Plant_ID==Plant_ID && model.Shop_ID==Shop_ID
                                    select new
                                    {
                                        line.Serial_No_Code
                                    }).FirstOrDefault();
                    if (LineCode != null)
                    {
                        serialNo += LineCode.Serial_No_Code.Trim().ToUpper();
                    }
                    else
                    {

                    }
                    var year = db.MM_Year.Where(m => m.Year == DateTime.Now.Year && m.Identifier_ID == 1).Select(m => m.Year_Code).FirstOrDefault();
                    if (year != null)
                    {
                        serialNo += year.Trim();
                    }


                    var month = db.MM_Month.Where(m => m.Month_No == DateTime.Now.Month && m.Identifier_ID == 1).Select(m => m.Month_Code).FirstOrDefault();
                    if (month != null)
                    {
                        serialNo += month.Trim();
                    }






                    if (runningSerialNumber != null)
                    {
                        //runningSerialNumber;
                    }
                    //if (runningSerialNumber < 10)
                    //{
                    //    serialNo = serialNo + "0" + runningSerialNumber.ToString();
                    //}

                    //else
                    //{
                    //    serialNo = serialNo + "" + runningSerialNumber.ToString();
                    //}
                    int number = 0;
                    if (runningSerialNumber < 10)
                    {
                        serialNo = serialNo.Trim() + "0000" + runningSerialNumber.ToString();
                    }
                    else
                        if (runningSerialNumber >= 10 && runningSerialNumber <= 99)
                    {
                        serialNo = serialNo + "000" + runningSerialNumber.ToString();
                    }
                    else if (runningSerialNumber > 99 && runningSerialNumber <= 999)
                    {
                        serialNo = serialNo + "00" + runningSerialNumber.ToString();
                    }
                    else if (runningSerialNumber > 999 && runningSerialNumber <= 9999)
                    {
                        serialNo = serialNo + "0" + runningSerialNumber.ToString();
                    }
                    else if (runningSerialNumber > 9999 && runningSerialNumber <= 99999)
                    {
                        serialNo = serialNo + runningSerialNumber.ToString();
                    }
                    var color_code = "";
                    bool IsColorCheck = db.MM_Model_Master.Where(m => m.Model_Code == ModelCode).Select(m => m.Color_Code).FirstOrDefault();
                    if (IsColorCheck)
                    {
                        //color_code = ModelCode.Substring(ModelCode.Length - 2, 2);
                        //serialNo += color_code;
                        //var color_Name = db.MM_Color.Where(m => m.COLOUR_ID == color_code).Select(c => c.COLOUR_DESC );
                        Mahindra_AD.Utility.Utility objUtility = new Mahindra_AD.Utility.Utility();
                        color_code = objUtility.GetStringColorCodeByModelCode(ModelCode);
                        serialNo += color_code;
                    }
                    else
                    {
                        color_code = db.MM_OM_OrderRelease.Where(m => m.Model_Code == ModelCode && m.Order_No == order_No).Select(m => m.Model_Color).FirstOrDefault();
                        serialNo += color_code;
                    }
                }
                return serialNo;
            }
            catch (Exception ex)
            {
               
                Utility.Utility objUtility = new Utility.Utility();
                objUtility.AddDataToHelpDesk(4, 2, 3, 19, 1, 1, 5, 59, "10.3.70.28", 71, "Error while genrating Serial No (" + runningSerialNumber + ") Generated for Order No : " + order_No, ex.Message + ex.InnerException + " Stack " + ex.StackTrace);
                objUtility = null;
                return "";
            }
        }

        public string getTrialBodySerialNumber(string ModelCode, int? runningSerialNumber, string order_No)
        {
            try
            {
                string serialNo = "N";
                if (ModelCode != null)
                {

                    var LineCode = (from model in db.MM_Model_Master.Where(m => m.Model_Code == ModelCode)
                                    join line in db.MM_OM_Platform
                                    on model.Platform_Id equals line.Platform_ID
                                    //where model.Plant_ID==Plant_ID && model.Shop_ID==Shop_ID
                                    select new
                                    {
                                        line.Serial_No_Code
                                    }).FirstOrDefault();
                    if (LineCode != null)
                    {
                        serialNo += LineCode.Serial_No_Code.Trim().ToUpper();
                    }
                    else
                    {

                    }
                    var year = db.MM_Year.Where(m => m.Year == DateTime.Now.Year).Select(m => m.Year_Code).FirstOrDefault();
                    if (year != null)
                    {
                        serialNo += year.Trim();
                    }

                    if (runningSerialNumber != null)
                    {
                        //runningSerialNumber;
                    }
                    //if (runningSerialNumber < 10)
                    //{
                    //    serialNo = serialNo + "0" + runningSerialNumber.ToString();
                    //}

                    //else
                    //{
                    //    serialNo = serialNo + "" + runningSerialNumber.ToString();
                    //}
                    int number = 0;
                    if (runningSerialNumber < 10)
                    {
                        serialNo = serialNo.Trim() + "0000" + runningSerialNumber.ToString();
                    }
                    else
                        if (runningSerialNumber >= 10 && runningSerialNumber <= 99)
                    {
                        serialNo = serialNo + "000" + runningSerialNumber.ToString();
                    }
                    else
                        if (runningSerialNumber > 99 && runningSerialNumber < 999)
                    {
                        serialNo = serialNo + "00" + runningSerialNumber.ToString();
                    }
                    else if (runningSerialNumber > 999 && runningSerialNumber < 9999)
                    {
                        serialNo = serialNo + "0" + runningSerialNumber.ToString();
                    }
                    else if (runningSerialNumber > 9999 && runningSerialNumber < 99999)
                    {
                        serialNo = serialNo + runningSerialNumber.ToString();
                    }
                    var color_code = "TR";
                    //bool IsColorCheck = db.MM_Model_Master.Where(m => m.Model_Code == ModelCode).Select(m => m.Color_Code).FirstOrDefault();
                    //if (IsColorCheck)
                    //{
                    //    color_code = ModelCode.Substring(ModelCode.Length - 2, 2);
                    //    serialNo += color_code;
                    //    //var color_Name = db.MM_Color.Where(m => m.COLOUR_ID == color_code).Select(c => c.COLOUR_DESC );
                    //}
                    //else
                    //{
                    //    color_code = db.MM_OM_OrderRelease.Where(m => m.Model_Code == ModelCode && m.Order_No == order_No).Select(m => m.Model_Color).FirstOrDefault();
                    //    serialNo += color_code;
                    //}
                    serialNo += color_code;
                }
                return serialNo;
            }
            catch (Exception ex)
            {

                return "";
            }
        }

        //added by mukesh for tear down serial number generation ending with TD
        public string getTearDownBodySerialNumber(string ModelCode, int? runningSerialNumber, string order_No)
        {
            try
            {
                string serialNo = "N";
                if (ModelCode != null)
                {

                    var LineCode = (from model in db.MM_Model_Master.Where(m => m.Model_Code == ModelCode)
                                    join line in db.MM_OM_Platform
                                    on model.Platform_Id equals line.Platform_ID
                                    //where model.Plant_ID==Plant_ID && model.Shop_ID==Shop_ID
                                    select new
                                    {
                                        line.Serial_No_Code
                                    }).FirstOrDefault();
                    if (LineCode != null)
                    {
                        serialNo += LineCode.Serial_No_Code.Trim().ToUpper();
                    }
                    else
                    {

                    }
                    var year = db.MM_Year.Where(m => m.Year == DateTime.Now.Year).Select(m => m.Year_Code).FirstOrDefault();
                    if (year != null)
                    {
                        serialNo += year.Trim();
                    }

                    if (runningSerialNumber != null)
                    {
                        //runningSerialNumber;
                    }
                    //if (runningSerialNumber < 10)
                    //{
                    //    serialNo = serialNo + "0" + runningSerialNumber.ToString();
                    //}

                    //else
                    //{
                    //    serialNo = serialNo + "" + runningSerialNumber.ToString();
                    //}
                    int number = 0;
                    if (runningSerialNumber < 10)
                    {
                        serialNo = serialNo.Trim() + "0000" + runningSerialNumber.ToString();
                    }
                    else
                        if (runningSerialNumber >= 10 && runningSerialNumber <= 99)
                    {
                        serialNo = serialNo + "000" + runningSerialNumber.ToString();
                    }
                    else
                        if (runningSerialNumber > 99 && runningSerialNumber < 999)
                    {
                        serialNo = serialNo + "00" + runningSerialNumber.ToString();
                    }
                    else if (runningSerialNumber > 999 && runningSerialNumber < 9999)
                    {
                        serialNo = serialNo + "0" + runningSerialNumber.ToString();
                    }
                    else if (runningSerialNumber > 9999 && runningSerialNumber < 99999)
                    {
                        serialNo = serialNo + runningSerialNumber.ToString();
                    }
                    var color_code = "TD";
                    //bool IsColorCheck = db.MM_Model_Master.Where(m => m.Model_Code == ModelCode).Select(m => m.Color_Code).FirstOrDefault();
                    //if (IsColorCheck)
                    //{
                    //    color_code = ModelCode.Substring(ModelCode.Length - 2, 2);
                    //    serialNo += color_code;
                    //    //var color_Name = db.MM_Color.Where(m => m.COLOUR_ID == color_code).Select(c => c.COLOUR_DESC );
                    //}
                    //else
                    //{
                    //    color_code = db.MM_OM_OrderRelease.Where(m => m.Model_Code == ModelCode && m.Order_No == order_No).Select(m => m.Model_Color).FirstOrDefault();
                    //    serialNo += color_code;
                    //}
                    serialNo += color_code;
                }
                return serialNo;
            }
            catch (Exception ex)
            {

                return "";
            }
        }

        /*               Action Name               : getVinNumberGenration
 *               Description               : Genration VIN Number logic 
 *               Author, Timestamp         : Rahul Varpe
 *               Input parameter           : ModelCode,lineId
 *               Return Type               : String
 *               Revision                  : VinNo
 */
        //public string getVinNumberGenration(string ModelCode, decimal lineId)
        //{
        //    try
        //    {
        //        //Total VIN NUMBER LENGTH : (17)
        //        //string VinNo = "MA1N";
        //        string VinNo = "";
        //        string dom_Year = ""; string exp_Year = "";
        //        string dom_month = ""; string exp_month = "";

        //        string country_type = "";
        //        string export_v = "";
        //        bool domesticNewYearVinNo = false;
        //        bool exportNewYearVinNO = false;
        //        bool domesticNewVinNoSeq = false;
        //        bool exportNewVinNoSeql = false;

        //        bool Country = false;


        //        if (ModelCode != null)
        //        {
        //            MM_MAST_VIN_LINE vin_Line;
        //            string lineIdS = Convert.ToString(lineId);
        //            //VIN Genration First 3 Digit Fixed -  Total : (3)
        //            var MA1 = (from model in db.MM_MAST_VIN_LINE.Where(m => m.AssyLine_ID == lineId)
        //                       select new
        //                       {
        //                           model.VIN1TO3,
        //                           model.isauto_domestic,
        //                           model.isauto_export,
        //                           model.current_year_domestic,
        //                           model.Current_year_export,
        //                           model.current_month_domestic,
        //                           model.Current_month_export,
        //                           model.PlantCode,
        //                           model.FROM_VIN,
        //                           model.To_VIN,
        //                           model.Next_Month_Export,
        //                           model.Next_Year_Export,
        //                           model.Domestic_NewYear,
        //                           model.Export_NewYear,
        //                           model.Next_Month_Domestic,
        //                           model.Next_Year_Domestic,
        //                           model.Domestic_New_VINNo_Seq,
        //                           model.Export_New_VINNo_Seq,
        //                           model.FROM_JAN_VIN,
        //                           model.TO_JAN_VIN

        //                       }).FirstOrDefault();

        //            if (MA1 != null)
        //            {
        //                VinNo = MA1.VIN1TO3;
        //                domesticNewYearVinNo = MA1.Domestic_NewYear ?? false;
        //                exportNewYearVinNO = MA1.Export_NewYear ?? false;
        //                domesticNewVinNoSeq = MA1.Domestic_New_VINNo_Seq ?? false;
        //                exportNewVinNoSeql = MA1.Export_New_VINNo_Seq ?? false;
        //            }
        //            else
        //            {
        //                VinNo = "MA1";
        //            }

        //            //VIN Genration Fourth 1 Digit Fixed  -  Total : (4)  
        //            VinNo += "N";

        //            var wd = "2";
        //            //VIN Genration Fifth 1 Digit Country/Left Hand Drive,Right Hand Drive  -  Total : (5)
        //            //Domestic Logic Start
        //            if (MA1 != null)
        //            {
        //                //-----------------------------------------New Logic (Developed by Rahul)-----------------------------------------//
        //                var model_new = db.MM_Model_Master.Where(m => m.Model_Code == ModelCode).FirstOrDefault();
        //                List<AttributionParameters> attributionParameters = (List<AttributionParameters>)Newtonsoft.Json.JsonConvert.DeserializeObject(model_new.Attribution_Parameters, typeof(List<AttributionParameters>));

        //                //Get Wheel Drive 2  or 4 Start  Added by Ashok on 24-12-2019
        //                //var objWheelDrive = attributionParameters.Where(m => m.label == "Wheel Drive");
        //                var objWheelDrive = attributionParameters.Where(m => m.label == "Wheel Drive");

        //                try
        //                {
        //                    if (objWheelDrive != null)
        //                    {
        //                        if (objWheelDrive.Count() > 0)
        //                        {
        //                            decimal attribId = Convert.ToDecimal(string.IsNullOrEmpty(objWheelDrive.FirstOrDefault().Value) ? "16" : objWheelDrive.FirstOrDefault().Value);

        //                            var wdId = db.MM_Attribution_Parameters.Where(m => m.Attribute_ID == attribId).Select(m => m);
        //                            if (wdId != null)
        //                            {
        //                                if (wdId.Count() > 0)
        //                                {
        //                                    wd = wdId.FirstOrDefault().Attribute_Code;
        //                                }
        //                            }
        //                        }
        //                    }
        //                }
        //                catch (Exception ex)
        //                {
        //                    wd = "2";
        //                }
        //                //Get Wheel Drive 2  or 4 End  Added by Ashok on 24-12-2019

        //                #region Check for Electric Vehicle 
        //                var isElecVehicle = false;
        //                var objElecVeh = attributionParameters.Where(m => m.label == "Fuel");
        //                try
        //                {
        //                    if (objElecVeh != null)
        //                    {
        //                        if (objElecVeh.Count() > 0 && !string.IsNullOrEmpty(objElecVeh.FirstOrDefault().Value))
        //                        {
        //                            var isNumber = objElecVeh.FirstOrDefault().Value.All(char.IsDigit);
        //                            if (isNumber)
        //                            {
        //                                decimal attribId = Convert.ToDecimal(objElecVeh.FirstOrDefault().Value);
        //                                //var fuelId = db.MM_Attribution_Parameters.Where(m => m.Attribute_ID == attribId).Select(m => m);
        //                                if (attribId == 29)
        //                                {
        //                                    isElecVehicle = true;
        //                                }
        //                            }

        //                        }
        //                    }
        //                }
        //                catch (Exception ex)
        //                {
        //                    isElecVehicle = false;
        //                }
        //                #endregion End check for Electric Vehicle 


        //                for (int i = 0; i < attributionParameters.Count; i++)
        //                {
        //                    AttributionParameters attributionParameter = attributionParameters[i];
        //                    try
        //                    {
        //                        Convert.ToInt32(attributionParameter.Value);
        //                    }
        //                    catch (Exception)
        //                    {
        //                        continue;
        //                    }

        //                    //Country Type
        //                    if (attributionParameter.label.Equals("Country Type", StringComparison.InvariantCultureIgnoreCase))
        //                    {
        //                        int attrId = Convert.ToInt32(attributionParameter.Value);
        //                        country_type = db.MM_Attribution_Parameters.Find(attrId).Attribute_Desc;
        //                    }

        //                }
        //                //---------------------------------------------------------------------------------------------------------//

        //                if (country_type == "")
        //                {
        //                    //----------------------------S220 body Vin logic change - Rahul Varpe(11-2-2023)------------------------------//
        //                    string S220_0 = "";
        //                    S220_0 = ModelCode.Substring(12, 2);
        //                    if (S220_0 == "3C" || S220_0 == "3D")
        //                    {
        //                        VinNo += "S";
        //                    }
        //                    else
        //                    {
        //                        if (!isElecVehicle)
        //                        {
        //                            VinNo += "M";
        //                        }
        //                        else
        //                        {
        //                            string S240 = "";
        //                            S240 = ModelCode.Substring(11, 2);
        //                            if (S240 == "09")
        //                            {
        //                                VinNo += "T";
        //                            }
        //                            else
        //                            {
        //                                VinNo += "R";
        //                            }
        //                        }
        //                    }
        //                    //--------------------------------------------------------------------------------------------------------------//

        //                    //Domestic Year
        //                    decimal d_year = MA1.current_year_domestic;
        //                    //decimal d_year = 2024;

        //                    if (domesticNewYearVinNo)
        //                    {
        //                        if (MA1.Next_Year_Domestic != null)
        //                        {
        //                            d_year = MA1.Next_Year_Domestic ?? MA1.current_year_domestic;
        //                            //d_year=2024;
        //                        }
        //                    }

        //                    var Domestic_Year = (from model in db.MM_Year.Where(m => m.Year == d_year && m.Identifier_ID == 1)
        //                                         select new
        //                                         {
        //                                             model.Year_Code
        //                                         }).FirstOrDefault();

        //                    if (Domestic_Year != null)
        //                    {
        //                        dom_Year = Domestic_Year.Year_Code;
        //                    }

        //                    //Domestic Month

        //                    int d_month_no = DateTime.Today.Month;
        //                    //int d_month = Convert.ToInt32(MA1.current_month_domestic);
        //                    // int d_month_no = 1;
        //                    if (domesticNewYearVinNo)
        //                    {
        //                        if (MA1.Next_Month_Domestic != null)
        //                        {
        //                            //d_month_no = Convert.ToInt32(MA1.Next_Month_Domestic);
        //                            //d_month_no = 1;
        //                            d_month_no = DateTime.Today.Month;
        //                        }
        //                    }

        //                    var Domestic_Month = (from model in db.MM_Month.Where(m => m.Month_No == d_month_no && m.Identifier_ID == 1)
        //                                          select new
        //                                          {
        //                                              model.Month_Code
        //                                          }).FirstOrDefault();

        //                    if (Domestic_Month != null)
        //                    {
        //                        dom_month = Domestic_Month.Month_Code;
        //                    }

        //                }//Domestic Logic if blank End

        //                if (country_type == "DOMESTIC")
        //                {
        //                    //----------------------S220 body Vin logic change - Rahul Varpe(11-2-2023)------------------------------------//
        //                    string S220_1 = "";
        //                    S220_1 = ModelCode.Substring(12, 2);
        //                    if (S220_1 == "3C" || S220_1 == "3D")
        //                    {
        //                        VinNo += "S";
        //                    }
        //                    else
        //                    {
        //                        if (!isElecVehicle)
        //                        {
        //                            VinNo += "M";
        //                        }
        //                        else
        //                        {

        //                            string S240 = "";
        //                            S240 = ModelCode.Substring(11, 2);
        //                            if (S240 == "09")
        //                            {
        //                                VinNo += "T";
        //                            }
        //                            else
        //                            {
        //                                VinNo += "R";
        //                            }
        //                        }
        //                    }

        //                    //-------------------------------------------------------------------------------------------------------------//
        //                    //Domestic Year
        //                    decimal d_year = MA1.current_year_domestic;
        //                    //decimal d_year = 2024;

        //                    if (domesticNewYearVinNo)
        //                    {
        //                        if (MA1.Next_Year_Domestic != null)
        //                        {
        //                            d_year = MA1.Next_Year_Domestic ?? MA1.current_year_domestic;
        //                            // d_year = 2024;
        //                        }
        //                    }
        //                    var Domestic_Year = (from model in db.MM_Year.Where(m => m.Year == d_year && m.Identifier_ID == 1)
        //                                         select new
        //                                         {
        //                                             model.Year_Code
        //                                         }).FirstOrDefault();

        //                    if (Domestic_Year != null)
        //                    {
        //                        dom_Year = Domestic_Year.Year_Code;
        //                    }

        //                    //Domestic Month
        //                    int d_month_no = DateTime.Today.Month;
        //                    //int d_month = Convert.ToInt32(MA1.current_month_domestic);
        //                    //int d_month_no = 1;

        //                    if (domesticNewYearVinNo)
        //                    {
        //                        if (MA1.Next_Month_Domestic != null)
        //                        {
        //                            // d_month_no = Convert.ToInt32(MA1.Next_Month_Domestic);
        //                            //d_month_no = 1;
        //                            d_month_no = DateTime.Today.Month;
        //                        }
        //                    }
        //                    var Domestic_Month = (from model in db.MM_Month.Where(m => m.Month_No == d_month_no && m.Identifier_ID == 1)
        //                                          select new
        //                                          {
        //                                              model.Month_Code
        //                                          }).FirstOrDefault();

        //                    if (Domestic_Month != null)
        //                    {
        //                        dom_month = Domestic_Month.Month_Code;
        //                    }

        //                }//Domestic Logic End

        //                //Export Logic Start
        //                if (country_type == "EXPORT")
        //                {
        //                    var model_Export = db.MM_Model_Master.Where(m => m.Model_Code == ModelCode).FirstOrDefault();
        //                    List<AttributionParameters> attributionParameters1 = (List<AttributionParameters>)Newtonsoft.Json.JsonConvert.DeserializeObject(model_new.Attribution_Parameters, typeof(List<AttributionParameters>));

        //                    for (int i = 0; i < attributionParameters1.Count; i++)
        //                    {
        //                        AttributionParameters attributionParameter1 = attributionParameters1[i];
        //                        try
        //                        {
        //                            Convert.ToInt32(attributionParameter1.Value);
        //                        }
        //                        catch (Exception)
        //                        {

        //                            continue;
        //                        }

        //                        //Country Type
        //                        if (attributionParameter1.label.Equals("Vehicle Drive", StringComparison.InvariantCultureIgnoreCase))
        //                        {
        //                            int attrId = Convert.ToInt32(attributionParameter1.Value);
        //                            export_v = db.MM_Attribution_Parameters.Find(attrId).Attribute_Code;
        //                        }

        //                    }

        //                    //----------------------S220 body Vin logic change - Rahul Varpe(11-2-2023)------------------------------------//
        //                    string S220_2 = "";
        //                    S220_2 = ModelCode.Substring(12, 2);
        //                    if (S220_2 == "3C" || S220_2 == "3D")
        //                    {
        //                        VinNo += "S";
        //                    }
        //                    else
        //                    {
        //                        //Right Hand or Left Hand
        //                        if (!isElecVehicle)
        //                        {
        //                            if (export_v == "R")
        //                            {
        //                                string S221 = "";
        //                                S221 = ModelCode.Substring(11, 2);
        //                                if (S221 == "10")
        //                                {
        //                                    VinNo += "Y";
        //                                }
        //                                else
        //                                {
        //                                    VinNo += "N";
        //                                }
        //                            }
        //                            else if (export_v == "L")
        //                            {
        //                                string S221 = "";
        //                                S221 = ModelCode.Substring(11, 2);
        //                                if (S221 == "10")
        //                                {
        //                                    VinNo += "Z";
        //                                }
        //                                else
        //                                {
        //                                    VinNo += "P";
        //                                }
        //                            }
        //                        }
        //                        else
        //                        {

        //                            string S240 = "";
        //                            S240 = ModelCode.Substring(11, 2);
        //                            if (S240 == "09")
        //                            {
        //                                VinNo += "T";
        //                            }
        //                            else
        //                            {
        //                                VinNo += "R";
        //                            }
        //                        }
        //                    }

        //                    //-------------------------------------------------------------------------------------------------------------//

        //                    var exportCountryList = System.Configuration.ConfigurationManager.AppSettings.Get("ExportCountryVinNoLogic");

        //                    //Export Year
        //                    decimal e_year = MA1.Current_year_export;
        //                    //decimal e_year = 2024;

        //                    if (Model_Code.Length > 14)
        //                    {
        //                        if (exportNewYearVinNO)
        //                        {
        //                            if (exportCountryList.Contains(Model_Code.Substring(14, 2)))
        //                            {
        //                                e_year = MA1.Next_Year_Export ?? MA1.Current_year_export;
        //                                //e_year = 2024;
        //                            }
        //                        }
        //                    }

        //                    var Export_Year = (from model in db.MM_Year.Where(m => m.Year == e_year && m.Identifier_ID == 1)
        //                                       select new
        //                                       {
        //                                           model.Year_Code
        //                                       }).FirstOrDefault();

        //                    if (Export_Year != null)
        //                    {
        //                        exp_Year = Export_Year.Year_Code;
        //                    }

        //                    //Export Month
        //                    int e_month_no = DateTime.Today.Month;
        //                    //int e_month_no = 13;
        //                    //// int e_month = Convert.ToInt32(MA1.Current_month_export);
        //                    // if (Model_Code.Substring(14, 2) == "01" && MA1.Next_Month_Export != null)

        //                    if (Model_Code.Length > 14)
        //                    {
        //                        if (exportNewYearVinNO)
        //                        {
        //                            if (exportCountryList.Contains(Model_Code.Substring(14, 2)) && MA1.Next_Month_Export != null && MA1.Next_Month_Export != 0)
        //                            {

        //                                //e_month_no = Convert.ToInt32(MA1.Next_Month_Export);
        //                                // e_month_no = 13;
        //                                e_month_no = DateTime.Today.Month;
        //                            }
        //                        }
        //                    }

        //                    var Export_Month = (from model in db.MM_Month.Where(m => m.Month_No == e_month_no && m.Identifier_ID == 1)
        //                                        select new
        //                                        {
        //                                            model.Month_Code
        //                                        }).FirstOrDefault();

        //                    if (Export_Month != null)
        //                    {
        //                        exp_month = Export_Month.Month_Code;
        //                    }

        //                } //Export Logic End

        //                //if (isElecVehicle)
        //                //{
        //                //    VinNo += "R";
        //                //}

        //            }

        //            ////VIN Genration Sixth 1 Digit Wheel Drive -  Total : (6)
        //            string Wheel_Drive = "";
        //            Wheel_Drive = wd;  // Added by Ashok on 24-12-2019 for wheel drive 
        //            //Wheel_Drive = ModelCode.Substring(3, 1);
        //            VinNo += Wheel_Drive;

        //            //VIN Genration Seventh,Eighth 2 Digit Engine Code -  Total : (8)
        //            string Engine_Code = "";
        //            Engine_Code = ModelCode.Substring(6, 2);
        //            VinNo += Engine_Code;

        //            //VIN Genration Ninth 1 Digit Transmission  -  Total : (9)

        //            //string Transmission = "";
        //            //Transmission = ModelCode.Substring(10, 1);
        //            //VinNo += Transmission;

        //            string Transmission = "";
        //            if (ModelCode.Substring(9, 1) == "M" && (ModelCode.Substring(11, 2) == "08" || ModelCode.Substring(11, 2) == "11") && ModelCode.Substring(6, 2) == "21")
        //            {
        //                Transmission = "M";
        //                VinNo += Transmission;
        //            }
        //            else if (ModelCode.Substring(9, 1) == "M" && ModelCode.Substring(11, 2) == "09" && ModelCode.Substring(6, 2) == "21")
        //            {
        //                Transmission = "M";
        //                VinNo += Transmission;
        //            }
        //            else if (ModelCode.Substring(9, 1) == "M" && ModelCode.Substring(4, 1) == "A" && ModelCode.Substring(6, 2) == "21")
        //            {
        //                Transmission = "H";
        //                VinNo += Transmission;
        //            }
        //            else
        //            {
        //                Transmission = ModelCode.Substring(10, 1);
        //                VinNo += Transmission;
        //            }


        //            if (MA1 != null)
        //            {
        //                //VIN Genration Tenth 1 Digit Year Code -  Total : (10)

        //                if (country_type == "DOMESTIC")
        //                {
        //                    VinNo += dom_Year;
        //                }
        //                else if (country_type == "EXPORT")
        //                {
        //                    VinNo += exp_Year;
        //                }
        //                else if (country_type == "")
        //                {
        //                    VinNo += dom_Year;
        //                }


        //                //if (MA1.isauto_domestic == true)
        //                //{
        //                //    VinNo += dom_Year;
        //                //}
        //                //else if (MA1.isauto_export == true)
        //                //{
        //                //    VinNo += exp_Year;
        //                //}


        //                //VIN Genration Eleventh 1 Digit Plant Code  -  Total : (11)
        //                string Plant_code = Convert.ToString(MA1.PlantCode);
        //                VinNo += Plant_code;

        //                //VIN Genration Tweleth 1 Digit Month Code  -  Total : (12)

        //                if (country_type == "DOMESTIC")
        //                {
        //                    VinNo += dom_month;
        //                }
        //                else if (country_type == "EXPORT")
        //                {
        //                    VinNo += exp_month;
        //                }
        //                else if (country_type == "")
        //                {
        //                    VinNo += dom_month;
        //                }


        //                //    if (MA1.isauto_domestic == true)
        //                //{
        //                //    VinNo += dom_month;
        //                //}
        //                //else if (MA1.isauto_export == true)
        //                //{
        //                //    VinNo += exp_month;
        //                //}

        //                //VIN Genration 5 Digit Serial Number -  Total : (17)

        //                decimal Serial_number = 0;
        //                decimal to_VIN = 0;
        //                //Serial_number = MA1.FROM_VIN;
        //                //to_VIN = MA1.To_VIN;
        //                if (country_type == "DOMESTIC" || country_type == "")
        //                {
        //                    Serial_number = MA1.FROM_VIN;
        //                    to_VIN = MA1.To_VIN;
        //                    if (domesticNewYearVinNo)
        //                    {
        //                        if (domesticNewVinNoSeq)
        //                        {
        //                            Serial_number = MA1.FROM_JAN_VIN ?? MA1.FROM_VIN;
        //                            to_VIN = MA1.TO_JAN_VIN ?? MA1.To_VIN;
        //                        }
        //                    }
        //                }
        //                else if (country_type == "EXPORT")
        //                {
        //                    Serial_number = MA1.FROM_VIN;
        //                    to_VIN = MA1.To_VIN;
        //                    if (exportNewYearVinNO)
        //                    {
        //                        if (exportNewVinNoSeql)
        //                        {
        //                            Serial_number = MA1.FROM_JAN_VIN ?? MA1.FROM_VIN;
        //                            to_VIN = MA1.TO_JAN_VIN ?? MA1.To_VIN;
        //                        }
        //                    }
        //                }







        //                if (to_VIN >= Serial_number)
        //                {
        //                    if (Serial_number != 0)
        //                    {
        //                        Serial_number = Serial_number + 1;
        //                        VinNo += Serial_number;

        //                        //---------------Update in FROM_VIN ------------------------//

        //                        vin_Line = new MM_MAST_VIN_LINE();
        //                        vin_Line = db.MM_MAST_VIN_LINE.Find(lineId);
        //                        //domesticNewVinNoSeq
        //                        //exportNewVinNoSeql
        //                        #region 
        //                        if (country_type == "DOMESTIC" || country_type == "")
        //                        {

        //                            if (domesticNewYearVinNo)
        //                            {
        //                                if (domesticNewVinNoSeq)
        //                                {
        //                                    vin_Line.FROM_JAN_VIN = Serial_number;
        //                                }
        //                                else
        //                                { vin_Line.FROM_VIN = Serial_number; }
        //                            }
        //                            else { vin_Line.FROM_VIN = Serial_number; }
        //                        }
        //                        else if (country_type == "EXPORT")
        //                        {

        //                            if (exportNewYearVinNO)
        //                            {
        //                                if (exportNewVinNoSeql)
        //                                {
        //                                    vin_Line.FROM_JAN_VIN = Serial_number;
        //                                }
        //                                else { vin_Line.FROM_VIN = Serial_number; }
        //                            }
        //                            else { vin_Line.FROM_VIN = Serial_number; }
        //                        }







        //                        #endregion




        //                        //vin_Line.FROM_VIN = Serial_number;0
        //                        if (VinNo.Length < 17)
        //                        { }
        //                        else
        //                        {
        //                            db.Entry(vin_Line).State = EntityState.Modified;
        //                            db.SaveChanges();
        //                        }
        //                        //----------------------------------------------------------//
        //                    }
        //                }
        //                else
        //                {
        //                    VinNo = null;
        //                }

        //            }
        //        }
        //        return VinNo;
        //    }
        //    catch (Exception ex)
        //    {
        //        Utility.Utility objUtility = new Utility.Utility();
        //        objUtility.AddDataToHelpDesk(4, 2, 3, 7, 1, 1, Convert.ToInt32(lineId), 59, "VMDT160052", 1, "Unable to generate Vin Number for Model Code " + ModelCode, ex.Message + ex.InnerException + " Stack " + ex.StackTrace);
        //        objUtility = null;
        //        return null;
        //    }
        //}



        ///New Logic Added  Dublicate vin number Finding


        public string getVinNumberGenration(string ModelCode, decimal lineId)
        {
            try
            {
                //Total VIN NUMBER LENGTH : (17)
                //string VinNo = "MA1N";
                string VinNo = "";
                string dom_Year = ""; string exp_Year = "";
                string dom_month = ""; string exp_month = "";

                string country_type = "";
                string export_v = "";
                bool domesticNewYearVinNo = false;
                bool exportNewYearVinNO = false;
                bool domesticNewVinNoSeq = false;
                bool exportNewVinNoSeql = false;

                bool Country = false;


                if (ModelCode != null)
                {
                    MM_MAST_VIN_LINE vin_Line;
                    string lineIdS = Convert.ToString(lineId);
                    //VIN Genration First 3 Digit Fixed -  Total : (3)
                    var MA1 = (from model in db.MM_MAST_VIN_LINE.Where(m => m.AssyLine_ID == lineId)
                               select new
                               {
                                   model.VIN1TO3,
                                   model.isauto_domestic,
                                   model.isauto_export,
                                   model.current_year_domestic,
                                   model.Current_year_export,
                                   model.current_month_domestic,
                                   model.Current_month_export,
                                   model.PlantCode,
                                   model.FROM_VIN,
                                   model.To_VIN,
                                   model.Next_Month_Export,
                                   model.Next_Year_Export,
                                   model.Domestic_NewYear,
                                   model.Export_NewYear,
                                   model.Next_Month_Domestic,
                                   model.Next_Year_Domestic,
                                   model.Domestic_New_VINNo_Seq,
                                   model.Export_New_VINNo_Seq,
                                   model.FROM_JAN_VIN,
                                   model.TO_JAN_VIN

                               }).FirstOrDefault();

                    if (MA1 != null)
                    {
                        VinNo = MA1.VIN1TO3;
                        domesticNewYearVinNo = MA1.Domestic_NewYear ?? false;
                        exportNewYearVinNO = MA1.Export_NewYear ?? false;
                        domesticNewVinNoSeq = MA1.Domestic_New_VINNo_Seq ?? false;
                        exportNewVinNoSeql = MA1.Export_New_VINNo_Seq ?? false;
                    }
                    else
                    {
                        VinNo = "MA1";
                    }

                    //VIN Genration Fourth 1 Digit Fixed  -  Total : (4)  
                    VinNo += "N";

                    var wd = "2";
                    //VIN Genration Fifth 1 Digit Country/Left Hand Drive,Right Hand Drive  -  Total : (5)
                    //Domestic Logic Start
                    if (MA1 != null)
                    {
                        //-----------------------------------------New Logic (Developed by Rahul)-----------------------------------------//
                        var model_new = db.MM_Model_Master.Where(m => m.Model_Code == ModelCode).FirstOrDefault();
                        List<AttributionParameters> attributionParameters = (List<AttributionParameters>)Newtonsoft.Json.JsonConvert.DeserializeObject(model_new.Attribution_Parameters, typeof(List<AttributionParameters>));

                        //Get Wheel Drive 2  or 4 Start  Added by Ashok on 24-12-2019
                        //var objWheelDrive = attributionParameters.Where(m => m.label == "Wheel Drive");
                        var objWheelDrive = attributionParameters.Where(m => m.label == "Wheel Drive");

                        try
                        {
                            if (objWheelDrive != null)
                            {
                                if (objWheelDrive.Count() > 0)
                                {
                                    decimal attribId = Convert.ToDecimal(string.IsNullOrEmpty(objWheelDrive.FirstOrDefault().Value) ? "16" : objWheelDrive.FirstOrDefault().Value);

                                    var wdId = db.MM_Attribution_Parameters.Where(m => m.Attribute_ID == attribId).Select(m => m);
                                    if (wdId != null)
                                    {
                                        if (wdId.Count() > 0)
                                        {
                                            wd = wdId.FirstOrDefault().Attribute_Code;
                                        }
                                    }
                                }
                            }
                        }
                        catch (Exception ex)
                        {
                            wd = "2";
                        }
                        //Get Wheel Drive 2  or 4 End  Added by Ashok on 24-12-2019

                        #region Check for Electric Vehicle 
                        var isElecVehicle = false;
                        var objElecVeh = attributionParameters.Where(m => m.label == "Fuel");
                        try
                        {
                            if (objElecVeh != null)
                            {
                                if (objElecVeh.Count() > 0 && !string.IsNullOrEmpty(objElecVeh.FirstOrDefault().Value))
                                {
                                    var isNumber = objElecVeh.FirstOrDefault().Value.All(char.IsDigit);
                                    if (isNumber)
                                    {
                                        decimal attribId = Convert.ToDecimal(objElecVeh.FirstOrDefault().Value);
                                        //var fuelId = db.MM_Attribution_Parameters.Where(m => m.Attribute_ID == attribId).Select(m => m);
                                        if (attribId == 29)
                                        {
                                            isElecVehicle = true;
                                        }
                                    }

                                }
                            }
                        }
                        catch (Exception ex)
                        {
                            isElecVehicle = false;
                        }
                        #endregion End check for Electric Vehicle 


                        for (int i = 0; i < attributionParameters.Count; i++)
                        {
                            AttributionParameters attributionParameter = attributionParameters[i];
                            try
                            {
                                Convert.ToInt32(attributionParameter.Value);
                            }
                            catch (Exception)
                            {
                                continue;
                            }

                            //Country Type
                            if (attributionParameter.label.Equals("Country Type", StringComparison.InvariantCultureIgnoreCase))
                            {
                                int attrId = Convert.ToInt32(attributionParameter.Value);
                                country_type = db.MM_Attribution_Parameters.Find(attrId).Attribute_Desc;
                            }

                        }
                        //---------------------------------------------------------------------------------------------------------//

                        if (country_type == "")
                        {
                            //----------------------------S220 body Vin logic change - Rahul Varpe(11-2-2023)------------------------------//
                            string S220_0 = "";
                            S220_0 = ModelCode.Substring(12, 2);
                            if (S220_0 == "3C" || S220_0 == "3D")
                            {
                                VinNo += "S";
                            }
                            else
                            {
                                if (!isElecVehicle)
                                {
                                    VinNo += "M";
                                }
                                else
                                {
                                    string S240 = "";
                                    S240 = ModelCode.Substring(11, 2);
                                    if (S240 == "09")
                                    {
                                        VinNo += "T";
                                    }
                                    else
                                    {
                                        VinNo += "R";
                                    }
                                }
                            }
                            //--------------------------------------------------------------------------------------------------------------//

                            //Domestic Year
                            decimal d_year = MA1.current_year_domestic;
                            //decimal d_year = 2024;

                            if (domesticNewYearVinNo)
                            {
                                if (MA1.Next_Year_Domestic != null)
                                {
                                    d_year = MA1.Next_Year_Domestic ?? MA1.current_year_domestic;
                                    //d_year=2024;
                                }
                            }

                            var Domestic_Year = (from model in db.MM_Year.Where(m => m.Year == d_year && m.Identifier_ID == 1)
                                                 select new
                                                 {
                                                     model.Year_Code
                                                 }).FirstOrDefault();

                            if (Domestic_Year != null)
                            {
                                dom_Year = Domestic_Year.Year_Code;
                            }

                            //Domestic Month

                            int d_month_no = DateTime.Today.Month;
                            //int d_month = Convert.ToInt32(MA1.current_month_domestic);
                            // int d_month_no = 1;
                            if (domesticNewYearVinNo)
                            {
                                if (MA1.Next_Month_Domestic != null)
                                {
                                    //d_month_no = Convert.ToInt32(MA1.Next_Month_Domestic);
                                    //d_month_no = 1;
                                    d_month_no = DateTime.Today.Month;
                                }
                            }

                            var Domestic_Month = (from model in db.MM_Month.Where(m => m.Month_No == d_month_no && m.Identifier_ID == 1)
                                                  select new
                                                  {
                                                      model.Month_Code
                                                  }).FirstOrDefault();

                            if (Domestic_Month != null)
                            {
                                dom_month = Domestic_Month.Month_Code;
                            }

                        }//Domestic Logic if blank End

                        if (country_type == "DOMESTIC")
                        {
                            //----------------------S220 body Vin logic change - Rahul Varpe(11-2-2023)------------------------------------//
                            string S220_1 = "";
                            S220_1 = ModelCode.Substring(12, 2);
                            if (S220_1 == "3C" || S220_1 == "3D")
                            {
                                VinNo += "S";
                            }
                            else
                            {
                                if (!isElecVehicle)
                                {
                                    VinNo += "M";
                                }
                                else
                                {

                                    string S240 = "";
                                    S240 = ModelCode.Substring(11, 2);
                                    if (S240 == "09")
                                    {
                                        VinNo += "T";
                                    }
                                    else
                                    {
                                        VinNo += "R";
                                    }
                                }
                            }

                            //-------------------------------------------------------------------------------------------------------------//
                            //Domestic Year
                            decimal d_year = MA1.current_year_domestic;
                            //decimal d_year = 2024;

                            if (domesticNewYearVinNo)
                            {
                                if (MA1.Next_Year_Domestic != null)
                                {
                                    d_year = MA1.Next_Year_Domestic ?? MA1.current_year_domestic;
                                    // d_year = 2024;
                                }
                            }
                            var Domestic_Year = (from model in db.MM_Year.Where(m => m.Year == d_year && m.Identifier_ID == 1)
                                                 select new
                                                 {
                                                     model.Year_Code
                                                 }).FirstOrDefault();

                            if (Domestic_Year != null)
                            {
                                dom_Year = Domestic_Year.Year_Code;
                            }

                            //Domestic Month
                            int d_month_no = DateTime.Today.Month;
                            //int d_month = Convert.ToInt32(MA1.current_month_domestic);
                            //int d_month_no = 1;

                            if (domesticNewYearVinNo)
                            {
                                if (MA1.Next_Month_Domestic != null)
                                {
                                    // d_month_no = Convert.ToInt32(MA1.Next_Month_Domestic);
                                    //d_month_no = 1;
                                    d_month_no = DateTime.Today.Month;
                                }
                            }
                            var Domestic_Month = (from model in db.MM_Month.Where(m => m.Month_No == d_month_no && m.Identifier_ID == 1)
                                                  select new
                                                  {
                                                      model.Month_Code
                                                  }).FirstOrDefault();

                            if (Domestic_Month != null)
                            {
                                dom_month = Domestic_Month.Month_Code;
                            }

                        }//Domestic Logic End

                        //Export Logic Start
                        if (country_type == "EXPORT")
                        {
                            var model_Export = db.MM_Model_Master.Where(m => m.Model_Code == ModelCode).FirstOrDefault();
                            List<AttributionParameters> attributionParameters1 = (List<AttributionParameters>)Newtonsoft.Json.JsonConvert.DeserializeObject(model_new.Attribution_Parameters, typeof(List<AttributionParameters>));

                            for (int i = 0; i < attributionParameters1.Count; i++)
                            {
                                AttributionParameters attributionParameter1 = attributionParameters1[i];
                                try
                                {
                                    Convert.ToInt32(attributionParameter1.Value);
                                }
                                catch (Exception)
                                {

                                    continue;
                                }

                                //Country Type
                                if (attributionParameter1.label.Equals("Vehicle Drive", StringComparison.InvariantCultureIgnoreCase))
                                {
                                    int attrId = Convert.ToInt32(attributionParameter1.Value);
                                    export_v = db.MM_Attribution_Parameters.Find(attrId).Attribute_Code;
                                }

                            }

                            //----------------------S220 body Vin logic change - Rahul Varpe(11-2-2023)------------------------------------//
                            string S220_2 = "";
                            S220_2 = ModelCode.Substring(12, 2);
                            if (S220_2 == "3C" || S220_2 == "3D")
                            {
                                VinNo += "S";
                            }
                            else
                            {
                                //Right Hand or Left Hand
                                if (!isElecVehicle)
                                {
                                    if (export_v == "R")
                                    {
                                        string S221 = "";
                                        S221 = ModelCode.Substring(11, 2);
                                        if (S221 == "10")
                                        {
                                            VinNo += "Y";
                                        }
                                        else
                                        {
                                            VinNo += "N";
                                        }
                                    }
                                    else if (export_v == "L")
                                    {
                                        string S221 = "";
                                        S221 = ModelCode.Substring(11, 2);
                                        if (S221 == "10")
                                        {
                                            VinNo += "Z";
                                        }
                                        else
                                        {
                                            VinNo += "P";
                                        }
                                    }
                                }
                                else
                                {

                                    string S240 = "";
                                    S240 = ModelCode.Substring(11, 2);
                                    if (S240 == "09")
                                    {
                                        VinNo += "T";
                                    }
                                    else
                                    {
                                        VinNo += "R";
                                    }
                                }
                            }

                            //-------------------------------------------------------------------------------------------------------------//

                            var exportCountryList = System.Configuration.ConfigurationManager.AppSettings.Get("ExportCountryVinNoLogic");

                            //Export Year
                            decimal e_year = MA1.Current_year_export;
                            //decimal e_year = 2024;

                            if (Model_Code.Length > 14)
                            {
                                if (exportNewYearVinNO)
                                {
                                    if (exportCountryList.Contains(Model_Code.Substring(14, 2)))
                                    {
                                        e_year = MA1.Next_Year_Export ?? MA1.Current_year_export;
                                        //e_year = 2024;
                                    }
                                }
                            }

                            var Export_Year = (from model in db.MM_Year.Where(m => m.Year == e_year && m.Identifier_ID == 1)
                                               select new
                                               {
                                                   model.Year_Code
                                               }).FirstOrDefault();

                            if (Export_Year != null)
                            {
                                exp_Year = Export_Year.Year_Code;
                            }

                            //Export Month
                            int e_month_no = DateTime.Today.Month;
                            //int e_month_no = 13;
                            //// int e_month = Convert.ToInt32(MA1.Current_month_export);
                            // if (Model_Code.Substring(14, 2) == "01" && MA1.Next_Month_Export != null)

                            if (Model_Code.Length > 14)
                            {
                                if (exportNewYearVinNO)
                                {
                                    if (exportCountryList.Contains(Model_Code.Substring(14, 2)) && MA1.Next_Month_Export != null && MA1.Next_Month_Export != 0)
                                    {

                                        //e_month_no = Convert.ToInt32(MA1.Next_Month_Export);
                                        // e_month_no = 13;
                                        e_month_no = DateTime.Today.Month;
                                    }
                                }
                            }

                            var Export_Month = (from model in db.MM_Month.Where(m => m.Month_No == e_month_no && m.Identifier_ID == 1)
                                                select new
                                                {
                                                    model.Month_Code
                                                }).FirstOrDefault();

                            if (Export_Month != null)
                            {
                                exp_month = Export_Month.Month_Code;
                            }

                        } //Export Logic End

                        //if (isElecVehicle)
                        //{
                        //    VinNo += "R";
                        //}

                    }

                    ////VIN Genration Sixth 1 Digit Wheel Drive -  Total : (6)
                    string Wheel_Drive = "";
                    Wheel_Drive = wd;  // Added by Ashok on 24-12-2019 for wheel drive 
                    //Wheel_Drive = ModelCode.Substring(3, 1);
                    VinNo += Wheel_Drive;

                    //VIN Genration Seventh,Eighth 2 Digit Engine Code -  Total : (8)
                    string Engine_Code = "";
                    Engine_Code = ModelCode.Substring(6, 2);
                    VinNo += Engine_Code;

                    //VIN Genration Ninth 1 Digit Transmission  -  Total : (9)

                    //string Transmission = "";
                    //Transmission = ModelCode.Substring(10, 1);
                    //VinNo += Transmission;

                    string Transmission = "";
                    if (ModelCode.Substring(9, 1) == "M" && (ModelCode.Substring(11, 2) == "08" || ModelCode.Substring(11, 2) == "11") && ModelCode.Substring(6, 2) == "21")
                    {
                        Transmission = "M";
                        VinNo += Transmission;
                    }
                    else if (ModelCode.Substring(9, 1) == "M" && ModelCode.Substring(11, 2) == "09" && ModelCode.Substring(6, 2) == "21")
                    {
                        Transmission = "M";
                        VinNo += Transmission;
                    }
                    else if (ModelCode.Substring(9, 1) == "M" && ModelCode.Substring(4, 1) == "A" && ModelCode.Substring(6, 2) == "21")
                    {
                        Transmission = "H";
                        VinNo += Transmission;
                    }
                    else
                    {
                        Transmission = ModelCode.Substring(10, 1);
                        VinNo += Transmission;
                    }


                    if (MA1 != null)
                    {
                        //VIN Genration Tenth 1 Digit Year Code -  Total : (10)

                        if (country_type == "DOMESTIC")
                        {
                            VinNo += dom_Year;
                        }
                        else if (country_type == "EXPORT")
                        {
                            VinNo += exp_Year;
                        }
                        else if (country_type == "")
                        {
                            VinNo += dom_Year;
                        }


                        //if (MA1.isauto_domestic == true)
                        //{
                        //    VinNo += dom_Year;
                        //}
                        //else if (MA1.isauto_export == true)
                        //{
                        //    VinNo += exp_Year;
                        //}


                        //VIN Genration Eleventh 1 Digit Plant Code  -  Total : (11)
                        string Plant_code = Convert.ToString(MA1.PlantCode);
                        VinNo += Plant_code;

                        //VIN Genration Tweleth 1 Digit Month Code  -  Total : (12)

                        if (country_type == "DOMESTIC")
                        {
                            VinNo += dom_month;
                        }
                        else if (country_type == "EXPORT")
                        {
                            VinNo += exp_month;
                        }
                        else if (country_type == "")
                        {
                            VinNo += dom_month;
                        }


                        //    if (MA1.isauto_domestic == true)
                        //{
                        //    VinNo += dom_month;
                        //}
                        //else if (MA1.isauto_export == true)
                        //{
                        //    VinNo += exp_month;
                        //}

                        //VIN Genration 5 Digit Serial Number -  Total : (17)

                        decimal Serial_number = 0;
                        decimal to_VIN = 0;
                        //Serial_number = MA1.FROM_VIN;
                        //to_VIN = MA1.To_VIN;
                        if (country_type == "DOMESTIC" || country_type == "")
                        {
                            Serial_number = MA1.FROM_VIN;
                            to_VIN = MA1.To_VIN;
                            if (domesticNewYearVinNo)
                            {
                                if (domesticNewVinNoSeq)
                                {
                                    Serial_number = MA1.FROM_JAN_VIN ?? MA1.FROM_VIN;
                                    to_VIN = MA1.TO_JAN_VIN ?? MA1.To_VIN;
                                }
                            }
                        }
                        else if (country_type == "EXPORT")
                        {
                            Serial_number = MA1.FROM_VIN;
                            to_VIN = MA1.To_VIN;
                            if (exportNewYearVinNO)
                            {
                                if (exportNewVinNoSeql)
                                {
                                    Serial_number = MA1.FROM_JAN_VIN ?? MA1.FROM_VIN;
                                    to_VIN = MA1.TO_JAN_VIN ?? MA1.To_VIN;
                                }
                            }
                        }







                        decimal newsrno = Serial_number + 1; //This is for duplicate vin testing
                        string newvinraw = VinNo;
                        string newvinno = newvinraw += newsrno; //This is for duplicate vin testing
                        string last8 = newvinno.Substring(newvinno.Length - 8);
                        int i = 0;


                        if (last8 != null)
                        {
                            try
                            {
                                con.Open();
                                SqlCommand cmd1 = new SqlCommand();
                                cmd1.Connection = con;
                                string sql = string.Empty;
                                cmd1.CommandText = "select count(*) from MM_OM_Order_List where Shop_ID = 1 and SUBSTRING(VIN_Number, 10,8) = '" + last8 + "'";
                                i = (int)cmd1.ExecuteScalar();

                            }
                            catch (Exception)
                            {
                                throw;
                            }
                            finally
                            {
                                con.Close();
                            }
                        }


                        if (i == 0)
                        {
                            if (to_VIN >= Serial_number)
                            {
                                if (Serial_number != 0)
                                {
                                    Serial_number = Serial_number + 1;
                                    VinNo += Serial_number;
                                    //---------------Update in FROM_VIN ------------------------//

                                    vin_Line = new MM_MAST_VIN_LINE();
                                    vin_Line = db.MM_MAST_VIN_LINE.Find(lineId);

                                    #region 
                                    if (country_type == "DOMESTIC" || country_type == "")
                                    {

                                        if (domesticNewYearVinNo)
                                        {
                                            if (domesticNewVinNoSeq)
                                            {
                                                vin_Line.FROM_JAN_VIN = Serial_number;
                                            }
                                            else
                                            {
                                                vin_Line.FROM_VIN = Serial_number;
                                            }
                                        }
                                        else
                                        {

                                            vin_Line.FROM_VIN = Serial_number;
                                        }
                                    }
                                    else if (country_type == "EXPORT")
                                    {

                                        if (exportNewYearVinNO)
                                        {
                                            if (exportNewVinNoSeql)
                                            {
                                                vin_Line.FROM_JAN_VIN = Serial_number;
                                            }
                                            else { vin_Line.FROM_VIN = Serial_number; }
                                        }
                                        else { vin_Line.FROM_VIN = Serial_number; }
                                    }
                                    #endregion

                                    //vin_Line.FROM_VIN = Serial_number;0
                                    if (VinNo.Length < 17)
                                    { }
                                    else
                                    {
                                        db.Entry(vin_Line).State = EntityState.Modified;
                                        db.SaveChanges();
                                    }
                                    //----------------------------------------------------------//
                                }
                            }
                            else
                            {
                                VinNo = null;
                            }
                        }
                        else
                        {
                            VinNo = "DuplicateDeteced";
                        }
                    }
                }
                return VinNo;
            }





            catch (Exception ex)
            {
                Utility.Utility objUtility = new Utility.Utility();
                objUtility.AddDataToHelpDesk(4, 2, 3, 7, 1, 1, Convert.ToInt32(lineId), 59, "VMDT160052", 1, "Unable to generate Vin Number for Model Code " + ModelCode, ex.Message + ex.InnerException + " Stack " + ex.StackTrace);
                objUtility = null;
                return null;
            }
        }


        public string getVinNumberGenration(string ModelCode, decimal lineId, string orderNo, int rowId)
        {
            try
            {
                //Total VIN NUMBER LENGTH : (17)
                //string VinNo = "MA1N";
                string VinNo = "";
                string dom_Year = ""; string exp_Year = "";
                string dom_month = ""; string exp_month = "";

                string country_type = "";
                string export_v = "";


                if (ModelCode != null)
                {


                    MM_MAST_VIN_LINE vin_Line;
                    string lineIdS = Convert.ToString(lineId);
                    //VIN Genration First 3 Digit Fixed -  Total : (3)
                    var MA1 = (from model in db.MM_MAST_VIN_LINE.Where(m => m.AssyLine_ID == lineId)
                               select new
                               {
                                   model.VIN1TO3,
                                   model.isauto_domestic,
                                   model.isauto_export,
                                   model.current_year_domestic,
                                   model.Current_year_export,
                                   model.current_month_domestic,
                                   model.Current_month_export,
                                   model.PlantCode,
                                   model.FROM_VIN,
                                   model.To_VIN,
                                   model.Next_Month_Export,
                                   model.Next_Year_Export
                               }).FirstOrDefault();

                    if (MA1 != null)
                    {
                        VinNo = MA1.VIN1TO3;
                    }
                    else
                    {
                        VinNo = "MA1";
                    }

                    //VIN Genration Fourth 1 Digit Fixed  -  Total : (4)  
                    VinNo += "N";

                    var wd = "2";
                    //VIN Genration Fifth 1 Digit Country/Left Hand Drive,Right Hand Drive  -  Total : (5)
                    //Domestic Logic Start
                    if (MA1 != null)
                    {
                        //---------------New Logic (Devlope by Rahul)------------------//
                        var model_new = db.MM_Model_Master.Where(m => m.Model_Code == ModelCode).FirstOrDefault();
                        List<AttributionParameters> attributionParameters = (List<AttributionParameters>)Newtonsoft.Json.JsonConvert.DeserializeObject(model_new.Attribution_Parameters, typeof(List<AttributionParameters>));

                        //Get Wheel Drive 2  or 4 Start  Added by Ashok on 24-12-2019
                        //var objWheelDrive = attributionParameters.Where(m => m.label == "Wheel Drive");
                        var objWheelDrive = attributionParameters.Where(m => m.label == "Wheel Drive");

                        try
                        {
                            if (objWheelDrive != null)
                            {
                                if (objWheelDrive.Count() > 0)
                                {
                                    decimal attribId = Convert.ToDecimal(string.IsNullOrEmpty(objWheelDrive.FirstOrDefault().Value) ? "16" : objWheelDrive.FirstOrDefault().Value);

                                    var wdId = db.MM_Attribution_Parameters.Where(m => m.Attribute_ID == attribId).Select(m => m);
                                    if (wdId != null)
                                    {
                                        if (wdId.Count() > 0)
                                        {
                                            wd = wdId.FirstOrDefault().Attribute_Code;
                                        }
                                    }
                                }
                            }
                        }
                        catch (Exception ex)
                        {
                            wd = "2";
                        }
                        //Get Wheel Drive 2  or 4 End  Added by Ashok on 24-12-2019

                        for (int i = 0; i < attributionParameters.Count; i++)
                        {
                            AttributionParameters attributionParameter = attributionParameters[i];
                            try
                            {
                                Convert.ToInt32(attributionParameter.Value);
                            }
                            catch (Exception)
                            {

                                continue;
                            }

                            //Country Type
                            if (attributionParameter.label.Equals("Country Type", StringComparison.InvariantCultureIgnoreCase))
                            {
                                int attrId = Convert.ToInt32(attributionParameter.Value);
                                country_type = db.MM_Attribution_Parameters.Find(attrId).Attribute_Desc;

                            }

                        }
                        //------------------------------------------------------------//

                        #region  To Check if Bulk Update done in OrderRelease table

                        var objOrderRelease = db.MM_OM_OrderRelease.Where(m => m.Order_No == orderNo && m.Row_ID==rowId).FirstOrDefault() ?? new MM_OM_OrderRelease();
                        if (objOrderRelease != null && objOrderRelease.Country_ID != 1 && objOrderRelease.Country_ID != 0)
                        {
                            var countryId = objOrderRelease.Country_ID;
                            var objCountryName = db.MM_Attribution_Parameters.Where(m => m.Attribute_ID == countryId).FirstOrDefault() ?? new MM_Attribution_Parameters();
                            var countryName = objCountryName.Attribute_Desc;
                            if (countryName != null && !string.IsNullOrEmpty(countryName))
                            {
                                if (countryName.Trim() != "India")
                                {
                                    country_type = "EXPORT";
                                }
                                else
                                {
                                    country_type = "DOMESTIC";
                                }
                            }
                        }
                        #endregion To Check if Bulk Update done in OrderRelease tablt 

                        if (country_type == "")
                        {
                            VinNo += "M";

                            //Domestic Year
                            decimal d_year = MA1.current_year_domestic;
                            var Domestic_Year = (from model in db.MM_Year.Where(m => m.Year == d_year && m.Identifier_ID == 1)
                                                 select new
                                                 {
                                                     model.Year_Code
                                                 }).FirstOrDefault();

                            if (Domestic_Year != null)
                            {
                                dom_Year = Domestic_Year.Year_Code;
                            }

                            //Domestic Month

                            int d_month_no = DateTime.Today.Month;
                            int d_month = Convert.ToInt32(MA1.current_month_domestic);
                            var Domestic_Month = (from model in db.MM_Month.Where(m => m.Month_No == d_month_no && m.Identifier_ID == 1)
                                                  select new
                                                  {
                                                      model.Month_Code
                                                  }).FirstOrDefault();

                            if (Domestic_Month != null)
                            {
                                dom_month = Domestic_Month.Month_Code;
                            }

                        }//Domestic Logic if blank End


                        if (country_type == "DOMESTIC")
                        {
                            VinNo += "M";

                            //Domestic Year
                            decimal d_year = MA1.current_year_domestic;
                            var Domestic_Year = (from model in db.MM_Year.Where(m => m.Year == d_year && m.Identifier_ID == 1)
                                                 select new
                                                 {
                                                     model.Year_Code
                                                 }).FirstOrDefault();

                            if (Domestic_Year != null)
                            {
                                dom_Year = Domestic_Year.Year_Code;
                            }

                            //Domestic Month
                            int d_month_no = DateTime.Today.Month;
                            int d_month = Convert.ToInt32(MA1.current_month_domestic);
                            var Domestic_Month = (from model in db.MM_Month.Where(m => m.Month_No == d_month_no && m.Identifier_ID == 1)
                                                  select new
                                                  {
                                                      model.Month_Code
                                                  }).FirstOrDefault();

                            if (Domestic_Month != null)
                            {
                                dom_month = Domestic_Month.Month_Code;
                            }

                        }//Domestic Logic End


                        //Export Logic Start

                        if (country_type == "EXPORT")
                        {

                            var model_Export = db.MM_Model_Master.Where(m => m.Model_Code == ModelCode).FirstOrDefault();
                            List<AttributionParameters> attributionParameters1 = (List<AttributionParameters>)Newtonsoft.Json.JsonConvert.DeserializeObject(model_new.Attribution_Parameters, typeof(List<AttributionParameters>));

                            for (int i = 0; i < attributionParameters1.Count; i++)
                            {
                                AttributionParameters attributionParameter1 = attributionParameters1[i];
                                try
                                {
                                    Convert.ToInt32(attributionParameter1.Value);
                                }
                                catch (Exception)
                                {

                                    continue;
                                }

                                //Country Type
                                if (attributionParameter1.label.Equals("Vehicle Drive", StringComparison.InvariantCultureIgnoreCase))
                                {
                                    int attrId = Convert.ToInt32(attributionParameter1.Value);
                                    export_v = db.MM_Attribution_Parameters.Find(attrId).Attribute_Code;

                                }

                            }

                            //Right Hand or Left Hand

                            if (export_v == "R")
                            {
                                VinNo += "N";
                            }
                            else if (export_v == "L")
                            {
                                VinNo += "P";
                            }
                            var exportCountryList = System.Configuration.ConfigurationManager.AppSettings.Get("ExportCountryVinNoLogic");

                            //Export Year
                            decimal e_year = MA1.Current_year_export;
                            if (Model_Code.Length > 14)
                            {
                                if (exportCountryList != null)
                                {
                                    if (exportCountryList.Contains(Model_Code.Substring(14, 2)))
                                    {
                                        e_year = MA1.Next_Year_Export ?? MA1.Current_year_export;
                                    }
                                }
                            }

                            var Export_Year = (from model in db.MM_Year.Where(m => m.Year == e_year && m.Identifier_ID == 1)
                                               select new
                                               {
                                                   model.Year_Code
                                               }).FirstOrDefault();

                            if (Export_Year != null)
                            {
                                exp_Year = Export_Year.Year_Code;
                            }

                            //Export Month
                            int e_month_no = DateTime.Today.Month;
                            // int e_month = Convert.ToInt32(MA1.Current_month_export);
                            // if (Model_Code.Substring(14, 2) == "01" && MA1.Next_Month_Export != null)
                            if (Model_Code.Length > 14)
                            {
                                if (exportCountryList != null)
                                {
                                    if (exportCountryList.Contains(Model_Code.Substring(14, 2)) && MA1.Next_Month_Export != null && MA1.Next_Month_Export != 0)
                                    {
                                        e_month_no = Convert.ToInt32(MA1.Next_Month_Export);
                                    }
                                }
                            }

                            var Export_Month = (from model in db.MM_Month.Where(m => m.Month_No == e_month_no && m.Identifier_ID == 1)
                                                select new
                                                {
                                                    model.Month_Code
                                                }).FirstOrDefault();

                            if (Export_Month != null)
                            {
                                exp_month = Export_Month.Month_Code;
                            }

                        } //Export Logic End
                    }

                    ////VIN Genration Sixth 1 Digit Wheel Drive -  Total : (6)
                    string Wheel_Drive = "";
                    Wheel_Drive = wd;  // Added by Ashok on 24-12-2019 for wheel drive 
                    //Wheel_Drive = ModelCode.Substring(3, 1);
                    VinNo += Wheel_Drive;

                    //VIN Genration Seventh,Eighth 2 Digit Engine Code -  Total : (8)
                    string Engine_Code = "";
                    Engine_Code = ModelCode.Substring(6, 2);
                    VinNo += Engine_Code;

                    //VIN Genration Ninth 1 Digit Transmission  -  Total : (9)
                    string Transmission = "";
                    Transmission = ModelCode.Substring(10, 1);
                    VinNo += Transmission;

                    if (MA1 != null)
                    {
                        //VIN Genration Tenth 1 Digit Year Code -  Total : (10)

                        if (country_type == "DOMESTIC")
                        {
                            VinNo += dom_Year;
                        }
                        else if (country_type == "EXPORT")
                        {
                            VinNo += exp_Year;
                        }
                        else if (country_type == "")
                        {
                            VinNo += dom_Year;
                        }


                        //if (MA1.isauto_domestic == true)
                        //{
                        //    VinNo += dom_Year;
                        //}
                        //else if (MA1.isauto_export == true)
                        //{
                        //    VinNo += exp_Year;
                        //}



                        //VIN Genration Eleventh 1 Digit Plant Code  -  Total : (11)
                        string Plant_code = Convert.ToString(MA1.PlantCode);
                        VinNo += Plant_code;

                        //VIN Genration Tweleth 1 Digit Month Code  -  Total : (12)

                        if (country_type == "DOMESTIC")
                        {
                            VinNo += dom_month;
                        }
                        else if (country_type == "EXPORT")
                        {
                            VinNo += exp_month;
                        }
                        else if (country_type == "")
                        {
                            VinNo += dom_month;
                        }


                        //    if (MA1.isauto_domestic == true)
                        //{
                        //    VinNo += dom_month;
                        //}
                        //else if (MA1.isauto_export == true)
                        //{
                        //    VinNo += exp_month;
                        //}

                        //VIN Genration 5 Digit Serial Number -  Total : (17)

                        decimal Serial_number = 0;
                        decimal to_VIN = 0;
                        Serial_number = MA1.FROM_VIN;
                        to_VIN = MA1.To_VIN;
                        if (to_VIN >= Serial_number)
                        {
                            if (Serial_number != 0)
                            {
                                Serial_number = Serial_number + 1;
                                VinNo += Serial_number;

                                //---------------Update in FROM_VIN ------------------------//

                                vin_Line = new MM_MAST_VIN_LINE();
                                vin_Line = db.MM_MAST_VIN_LINE.Find(lineId);
                                vin_Line.FROM_VIN = Serial_number;

                                db.Entry(vin_Line).State = EntityState.Modified;
                                db.SaveChanges();
                                //----------------------------------------------------------//
                            }
                        }
                        else
                        {
                            VinNo = null;
                        }

                    }
                }
                return VinNo;
            }
            catch (Exception ex)
            {
                return null;
            }
        }

        ///Next Year Vin Number ///////
        //public string getVinNumberGenration(string ModelCode, decimal lineId)
        //{
        //    try
        //    {
        //        //Total VIN NUMBER LENGTH : (17)
        //        //string VinNo = "MA1N";
        //        string VinNo = "";
        //        string dom_Year = ""; string exp_Year = "";
        //        string dom_month = ""; string exp_month = "";

        //        string country_type = "";
        //        string export_v = "";
        //        bool domesticNewYearVinNo = false;
        //        bool exportNewYearVinNO = false;
        //        bool domesticNewVinNoSeq = false;
        //        bool exportNewVinNoSeql = false;

        //        bool Country = false;


        //        if (ModelCode != null)
        //        {
        //            MM_MAST_VIN_LINE vin_Line;
        //            string lineIdS = Convert.ToString(lineId);
        //            //VIN Genration First 3 Digit Fixed -  Total : (3)
        //            var MA1 = (from model in db.MM_MAST_VIN_LINE.Where(m => m.AssyLine_ID == lineId)
        //                       select new
        //                       {
        //                           model.VIN1TO3,
        //                           model.isauto_domestic,
        //                           model.isauto_export,
        //                           model.current_year_domestic,
        //                           model.Current_year_export,
        //                           model.current_month_domestic,
        //                           model.Current_month_export,
        //                           model.PlantCode,
        //                           model.FROM_VIN,
        //                           model.To_VIN,
        //                           model.Next_Month_Export,
        //                           model.Next_Year_Export,
        //                           model.Domestic_NewYear,
        //                           model.Export_NewYear,
        //                           model.Next_Month_Domestic,
        //                           model.Next_Year_Domestic,
        //                           model.Domestic_New_VINNo_Seq,
        //                           model.Export_New_VINNo_Seq,
        //                           model.FROM_JAN_VIN,
        //                           model.TO_JAN_VIN

        //                       }).FirstOrDefault();

        //            if (MA1 != null)
        //            {
        //                VinNo = MA1.VIN1TO3;
        //                domesticNewYearVinNo = MA1.Domestic_NewYear ?? false;
        //                exportNewYearVinNO = MA1.Export_NewYear ?? false;
        //                domesticNewVinNoSeq = MA1.Domestic_New_VINNo_Seq ?? false;
        //                exportNewVinNoSeql = MA1.Export_New_VINNo_Seq ?? false;
        //            }
        //            else
        //            {
        //                VinNo = "MA1";
        //            }

        //            //VIN Genration Fourth 1 Digit Fixed  -  Total : (4)  
        //            VinNo += "N";

        //            var wd = "2";
        //            //VIN Genration Fifth 1 Digit Country/Left Hand Drive,Right Hand Drive  -  Total : (5)
        //            //Domestic Logic Start
        //            if (MA1 != null)
        //            {
        //                //-----------------------------------------New Logic (Developed by Rahul)-----------------------------------------//
        //                var model_new = db.MM_Model_Master.Where(m => m.Model_Code == ModelCode).FirstOrDefault();
        //                List<AttributionParameters> attributionParameters = (List<AttributionParameters>)Newtonsoft.Json.JsonConvert.DeserializeObject(model_new.Attribution_Parameters, typeof(List<AttributionParameters>));

        //                //Get Wheel Drive 2  or 4 Start  Added by Ashok on 24-12-2019
        //                //var objWheelDrive = attributionParameters.Where(m => m.label == "Wheel Drive");
        //                var objWheelDrive = attributionParameters.Where(m => m.label == "Wheel Drive");

        //                try
        //                {
        //                    if (objWheelDrive != null)
        //                    {
        //                        if (objWheelDrive.Count() > 0)
        //                        {
        //                            decimal attribId = Convert.ToDecimal(string.IsNullOrEmpty(objWheelDrive.FirstOrDefault().Value) ? "16" : objWheelDrive.FirstOrDefault().Value);

        //                            var wdId = db.MM_Attribution_Parameters.Where(m => m.Attribute_ID == attribId).Select(m => m);
        //                            if (wdId != null)
        //                            {
        //                                if (wdId.Count() > 0)
        //                                {
        //                                    wd = wdId.FirstOrDefault().Attribute_Code;
        //                                }
        //                            }
        //                        }
        //                    }
        //                }
        //                catch (Exception ex)
        //                {
        //                    wd = "2";
        //                }
        //                //Get Wheel Drive 2  or 4 End  Added by Ashok on 24-12-2019

        //                #region Check for Electric Vehicle 
        //                var isElecVehicle = false;
        //                var objElecVeh = attributionParameters.Where(m => m.label == "Fuel");
        //                try
        //                {
        //                    if (objElecVeh != null)
        //                    {
        //                        if (objElecVeh.Count() > 0 && !string.IsNullOrEmpty(objElecVeh.FirstOrDefault().Value))
        //                        {
        //                            var isNumber = objElecVeh.FirstOrDefault().Value.All(char.IsDigit);
        //                            if (isNumber)
        //                            {
        //                                decimal attribId = Convert.ToDecimal(objElecVeh.FirstOrDefault().Value);
        //                                //var fuelId = db.MM_Attribution_Parameters.Where(m => m.Attribute_ID == attribId).Select(m => m);
        //                                if (attribId == 29)
        //                                {
        //                                    isElecVehicle = true;
        //                                }
        //                            }

        //                        }
        //                    }
        //                }
        //                catch (Exception ex)
        //                {
        //                    isElecVehicle = false;
        //                }
        //                #endregion End check for Electric Vehicle 


        //                for (int i = 0; i < attributionParameters.Count; i++)
        //                {
        //                    AttributionParameters attributionParameter = attributionParameters[i];
        //                    try
        //                    {
        //                        Convert.ToInt32(attributionParameter.Value);
        //                    }
        //                    catch (Exception)
        //                    {
        //                        continue;
        //                    }

        //                    //Country Type
        //                    if (attributionParameter.label.Equals("Country Type", StringComparison.InvariantCultureIgnoreCase))
        //                    {
        //                        int attrId = Convert.ToInt32(attributionParameter.Value);
        //                        country_type = db.MM_Attribution_Parameters.Find(attrId).Attribute_Desc;
        //                    }

        //                }
        //                //---------------------------------------------------------------------------------------------------------//

        //                if (country_type == "")
        //                {
        //                    //----------------------------S220 body Vin logic change - Rahul Varpe(11-2-2023)------------------------------//
        //                    string S220_0 = "";
        //                    S220_0 = ModelCode.Substring(12, 2);
        //                    if (S220_0 == "3C" || S220_0 == "3D")
        //                    {
        //                        VinNo += "S";
        //                    }
        //                    else
        //                    {
        //                        if (!isElecVehicle)
        //                        {
        //                            VinNo += "M";
        //                        }
        //                        else
        //                        {
        //                            string S240 = "";
        //                            S240 = ModelCode.Substring(11, 2);
        //                            if (S240 == "09")
        //                            {
        //                                VinNo += "T";
        //                            }
        //                            else
        //                            {
        //                                VinNo += "R";
        //                            }
        //                        }
        //                    }
        //                    //--------------------------------------------------------------------------------------------------------------//

        //                    //Domestic Year
        //                    //decimal d_year = MA1.current_year_domestic;
        //                    decimal d_year = 2025;

        //                    if (domesticNewYearVinNo)
        //                    {
        //                        if (MA1.Next_Year_Domestic != null)
        //                        {
        //                            //d_year = MA1.Next_Year_Domestic ?? MA1.current_year_domestic;
        //                            d_year = 2025;
        //                        }
        //                    }

        //                    var Domestic_Year = (from model in db.MM_Year.Where(m => m.Year == d_year && m.Identifier_ID == 1)
        //                                         select new
        //                                         {
        //                                             model.Year_Code
        //                                         }).FirstOrDefault();

        //                    if (Domestic_Year != null)
        //                    {
        //                        dom_Year = Domestic_Year.Year_Code;
        //                    }

        //                    //Domestic Month

        //                    //  int d_month_no = DateTime.Today.Month;
        //                    //int d_month = Convert.ToInt32(MA1.current_month_domestic);
        //                    int d_month_no = 1;
        //                    if (domesticNewYearVinNo)
        //                    {
        //                        if (MA1.Next_Month_Domestic != null)
        //                        {
        //                            //d_month_no = Convert.ToInt32(MA1.Next_Month_Domestic);
        //                            //d_month_no = 1;
        //                            d_month_no = DateTime.Today.Month;
        //                        }
        //                    }

        //                    var Domestic_Month = (from model in db.MM_Month.Where(m => m.Month_No == d_month_no && m.Identifier_ID == 1)
        //                                          select new
        //                                          {
        //                                              model.Month_Code
        //                                          }).FirstOrDefault();

        //                    if (Domestic_Month != null)
        //                    {
        //                        dom_month = Domestic_Month.Month_Code;
        //                    }

        //                }//Domestic Logic if blank End

        //                if (country_type == "DOMESTIC")
        //                {
        //                    //----------------------S220 body Vin logic change - Rahul Varpe(11-2-2023)------------------------------------//
        //                    string S220_1 = "";
        //                    S220_1 = ModelCode.Substring(12, 2);
        //                    if (S220_1 == "3C" || S220_1 == "3D")
        //                    {
        //                        VinNo += "S";
        //                    }
        //                    else
        //                    {
        //                        if (!isElecVehicle)
        //                        {
        //                            VinNo += "M";
        //                        }
        //                        else
        //                        {

        //                            string S240 = "";
        //                            S240 = ModelCode.Substring(11, 2);
        //                            if (S240 == "09")
        //                            {
        //                                VinNo += "T";
        //                            }
        //                            else
        //                            {
        //                                VinNo += "R";
        //                            }
        //                        }
        //                    }

        //                    //-------------------------------------------------------------------------------------------------------------//
        //                    //Domestic Year
        //                    //decimal d_year = MA1.current_year_domestic;
        //                    decimal d_year = 2025;

        //                    if (domesticNewYearVinNo)
        //                    {
        //                        if (MA1.Next_Year_Domestic != null)
        //                        {
        //                            //d_year = MA1.Next_Year_Domestic ?? MA1.current_year_domestic;
        //                            d_year = 2025;
        //                        }
        //                    }
        //                    var Domestic_Year = (from model in db.MM_Year.Where(m => m.Year == d_year && m.Identifier_ID == 1)
        //                                         select new
        //                                         {
        //                                             model.Year_Code
        //                                         }).FirstOrDefault();

        //                    if (Domestic_Year != null)
        //                    {
        //                        dom_Year = Domestic_Year.Year_Code;
        //                    }

        //                    //Domestic Month
        //                    //int d_month_no = DateTime.Today.Month;
        //                    //int d_month = Convert.ToInt32(MA1.current_month_domestic);
        //                    int d_month_no = 1;

        //                    if (domesticNewYearVinNo)
        //                    {
        //                        if (MA1.Next_Month_Domestic != null)
        //                        {
        //                            // d_month_no = Convert.ToInt32(MA1.Next_Month_Domestic);
        //                            d_month_no = 1;
        //                            //d_month_no = DateTime.Today.Month;
        //                        }
        //                    }
        //                    var Domestic_Month = (from model in db.MM_Month.Where(m => m.Month_No == d_month_no && m.Identifier_ID == 1)
        //                                          select new
        //                                          {
        //                                              model.Month_Code
        //                                          }).FirstOrDefault();

        //                    if (Domestic_Month != null)
        //                    {
        //                        dom_month = Domestic_Month.Month_Code;
        //                    }

        //                }//Domestic Logic End

        //                //Export Logic Start
        //                if (country_type == "EXPORT")
        //                {
        //                    var model_Export = db.MM_Model_Master.Where(m => m.Model_Code == ModelCode).FirstOrDefault();
        //                    List<AttributionParameters> attributionParameters1 = (List<AttributionParameters>)Newtonsoft.Json.JsonConvert.DeserializeObject(model_new.Attribution_Parameters, typeof(List<AttributionParameters>));

        //                    for (int i = 0; i < attributionParameters1.Count; i++)
        //                    {
        //                        AttributionParameters attributionParameter1 = attributionParameters1[i];
        //                        try
        //                        {
        //                            Convert.ToInt32(attributionParameter1.Value);
        //                        }
        //                        catch (Exception)
        //                        {

        //                            continue;
        //                        }

        //                        //Country Type
        //                        if (attributionParameter1.label.Equals("Vehicle Drive", StringComparison.InvariantCultureIgnoreCase))
        //                        {
        //                            int attrId = Convert.ToInt32(attributionParameter1.Value);
        //                            export_v = db.MM_Attribution_Parameters.Find(attrId).Attribute_Code;
        //                        }

        //                    }

        //                    //----------------------S220 body Vin logic change - Rahul Varpe(11-2-2023)------------------------------------//
        //                    string S220_2 = "";
        //                    S220_2 = ModelCode.Substring(12, 2);
        //                    if (S220_2 == "3C" || S220_2 == "3D")
        //                    {
        //                        VinNo += "S";
        //                    }
        //                    else
        //                    {
        //                        //Right Hand or Left Hand
        //                        if (!isElecVehicle)
        //                        {
        //                            if (export_v == "R")
        //                            {
        //                                string S221 = "";
        //                                S221 = ModelCode.Substring(11, 2);
        //                                if (S221 == "10")
        //                                {
        //                                    VinNo += "Y";
        //                                }
        //                                else
        //                                {
        //                                    VinNo += "N";
        //                                }
        //                            }
        //                            else if (export_v == "L")
        //                            {
        //                                string S221 = "";
        //                                S221 = ModelCode.Substring(11, 2);
        //                                if (S221 == "10")
        //                                {
        //                                    VinNo += "Z";
        //                                }
        //                                else
        //                                {
        //                                    VinNo += "P";
        //                                }
        //                            }
        //                        }
        //                        else
        //                        {

        //                            string S240 = "";
        //                            S240 = ModelCode.Substring(11, 2);
        //                            if (S240 == "09")
        //                            {
        //                                VinNo += "T";
        //                            }
        //                            else
        //                            {
        //                                VinNo += "R";
        //                            }
        //                        }
        //                    }

        //                    //-------------------------------------------------------------------------------------------------------------//

        //                    var exportCountryList = System.Configuration.ConfigurationManager.AppSettings.Get("ExportCountryVinNoLogic");

        //                    //Export Year
        //                    //decimal e_year = MA1.Current_year_export;
        //                    decimal e_year = 2025;

        //                    if (Model_Code.Length > 14)
        //                    {
        //                        if (exportNewYearVinNO)
        //                        {
        //                            if (exportCountryList.Contains(Model_Code.Substring(14, 2)))
        //                            {
        //                                //  e_year = MA1.Next_Year_Export ?? MA1.Current_year_export;
        //                                e_year = 2025;
        //                            }
        //                        }
        //                    }

        //                    var Export_Year = (from model in db.MM_Year.Where(m => m.Year == e_year && m.Identifier_ID == 1)
        //                                       select new
        //                                       {
        //                                           model.Year_Code
        //                                       }).FirstOrDefault();

        //                    if (Export_Year != null)
        //                    {
        //                        exp_Year = Export_Year.Year_Code;
        //                    }

        //                    //Export Month
        //                    // int e_month_no = DateTime.Today.Month;
        //                    int e_month_no = 13;
        //                    //// int e_month = Convert.ToInt32(MA1.Current_month_export);
        //                    // if (Model_Code.Substring(14, 2) == "01" && MA1.Next_Month_Export != null)

        //                    if (Model_Code.Length > 14)
        //                    {
        //                        if (exportNewYearVinNO)
        //                        {
        //                            if (exportCountryList.Contains(Model_Code.Substring(14, 2)) && MA1.Next_Month_Export != null && MA1.Next_Month_Export != 0)
        //                            {

        //                                //e_month_no = Convert.ToInt32(MA1.Next_Month_Export);
        //                                e_month_no = 13;
        //                                //e_month_no = DateTime.Today.Month;
        //                            }
        //                        }
        //                    }

        //                    var Export_Month = (from model in db.MM_Month.Where(m => m.Month_No == e_month_no && m.Identifier_ID == 1)
        //                                        select new
        //                                        {
        //                                            model.Month_Code
        //                                        }).FirstOrDefault();

        //                    if (Export_Month != null)
        //                    {
        //                        exp_month = Export_Month.Month_Code;
        //                    }

        //                } //Export Logic End

        //                //if (isElecVehicle)
        //                //{
        //                //    VinNo += "R";
        //                //}

        //            }

        //            ////VIN Genration Sixth 1 Digit Wheel Drive -  Total : (6)
        //            string Wheel_Drive = "";
        //            Wheel_Drive = wd;  // Added by Ashok on 24-12-2019 for wheel drive 
        //            //Wheel_Drive = ModelCode.Substring(3, 1);
        //            VinNo += Wheel_Drive;

        //            //VIN Genration Seventh,Eighth 2 Digit Engine Code -  Total : (8)
        //            string Engine_Code = "";
        //            Engine_Code = ModelCode.Substring(6, 2);
        //            VinNo += Engine_Code;

        //            //VIN Genration Ninth 1 Digit Transmission  -  Total : (9)

        //            //string Transmission = "";
        //            //Transmission = ModelCode.Substring(10, 1);
        //            //VinNo += Transmission;

        //            string Transmission = "";
        //            if (ModelCode.Substring(9, 1) == "M" && (ModelCode.Substring(11, 2) == "08" || ModelCode.Substring(11, 2) == "11") && ModelCode.Substring(6, 2) == "21")
        //            {
        //                Transmission = "M";
        //                VinNo += Transmission;
        //            }
        //            else if (ModelCode.Substring(9, 1) == "M" && ModelCode.Substring(11, 2) == "09" && ModelCode.Substring(6, 2) == "21")
        //            {
        //                Transmission = "M";
        //                VinNo += Transmission;
        //            }
        //            else if (ModelCode.Substring(9, 1) == "M" && ModelCode.Substring(4, 1) == "A" && ModelCode.Substring(6, 2) == "21")
        //            {
        //                Transmission = "H";
        //                VinNo += Transmission;
        //            }
        //            else
        //            {
        //                Transmission = ModelCode.Substring(10, 1);
        //                VinNo += Transmission;
        //            }


        //            if (MA1 != null)
        //            {
        //                //VIN Genration Tenth 1 Digit Year Code -  Total : (10)

        //                if (country_type == "DOMESTIC")
        //                {
        //                    VinNo += dom_Year;
        //                }
        //                else if (country_type == "EXPORT")
        //                {
        //                    VinNo += exp_Year;
        //                }
        //                else if (country_type == "")
        //                {
        //                    VinNo += dom_Year;
        //                }


        //                //if (MA1.isauto_domestic == true)
        //                //{
        //                //    VinNo += dom_Year;
        //                //}
        //                //else if (MA1.isauto_export == true)
        //                //{
        //                //    VinNo += exp_Year;
        //                //}


        //                //VIN Genration Eleventh 1 Digit Plant Code  -  Total : (11)
        //                string Plant_code = Convert.ToString(MA1.PlantCode);
        //                VinNo += Plant_code;

        //                //VIN Genration Tweleth 1 Digit Month Code  -  Total : (12)

        //                if (country_type == "DOMESTIC")
        //                {
        //                    VinNo += dom_month;
        //                }
        //                else if (country_type == "EXPORT")
        //                {
        //                    VinNo += exp_month;
        //                }
        //                else if (country_type == "")
        //                {
        //                    VinNo += dom_month;
        //                }


        //                //    if (MA1.isauto_domestic == true)
        //                //{
        //                //    VinNo += dom_month;
        //                //}
        //                //else if (MA1.isauto_export == true)
        //                //{
        //                //    VinNo += exp_month;
        //                //}

        //                //VIN Genration 5 Digit Serial Number -  Total : (17)

        //                decimal Serial_number = 0;
        //                decimal to_VIN = 0;
        //                //Serial_number = MA1.FROM_VIN;
        //                //to_VIN = MA1.To_VIN;
        //                if (country_type == "DOMESTIC" || country_type == "")
        //                {
        //                    Serial_number = MA1.FROM_VIN;
        //                    to_VIN = MA1.To_VIN;
        //                    if (domesticNewYearVinNo)
        //                    {
        //                        if (domesticNewVinNoSeq)
        //                        {
        //                            Serial_number = MA1.FROM_JAN_VIN ?? MA1.FROM_VIN;
        //                            to_VIN = MA1.TO_JAN_VIN ?? MA1.To_VIN;
        //                        }
        //                    }
        //                }
        //                else if (country_type == "EXPORT")
        //                {
        //                    Serial_number = MA1.FROM_VIN;
        //                    to_VIN = MA1.To_VIN;
        //                    if (exportNewYearVinNO)
        //                    {
        //                        if (exportNewVinNoSeql)
        //                        {
        //                            Serial_number = MA1.FROM_JAN_VIN ?? MA1.FROM_VIN;
        //                            to_VIN = MA1.TO_JAN_VIN ?? MA1.To_VIN;
        //                        }
        //                    }
        //                }


        //                decimal newsrno = Serial_number + 1; //This is for duplicate vin testing
        //                string newvinraw = VinNo;
        //                string newvinno = newvinraw += newsrno; //This is for duplicate vin testing
        //                string last8 = newvinno.Substring(newvinno.Length - 8);
        //                int i = 0;


        //                if (last8 != null)
        //                {
        //                    try
        //                    {
        //                        con.Open();
        //                        SqlCommand cmd1 = new SqlCommand();
        //                        cmd1.Connection = con;
        //                        string sql = string.Empty;
        //                        cmd1.CommandText = "select count(*) from MM_OM_Order_List where Shop_ID = 1 and SUBSTRING(VIN_Number, 10,8) = '" + last8 + "'";
        //                        i = (int)cmd1.ExecuteScalar();

        //                    }
        //                    catch (Exception)
        //                    {
        //                        throw;
        //                    }
        //                    finally
        //                    {
        //                        con.Close();
        //                    }
        //                }


        //                if (i == 0)
        //                {
        //                    if (to_VIN >= Serial_number)
        //                    {
        //                        if (Serial_number != 0)
        //                        {
        //                            Serial_number = Serial_number + 1;
        //                            VinNo += Serial_number;
        //                            //---------------Update in FROM_VIN ------------------------//

        //                            vin_Line = new MM_MAST_VIN_LINE();
        //                            vin_Line = db.MM_MAST_VIN_LINE.Find(lineId);

        //                            #region 
        //                            if (country_type == "DOMESTIC" || country_type == "")
        //                            {

        //                                if (domesticNewYearVinNo)
        //                                {
        //                                    if (domesticNewVinNoSeq)
        //                                    {
        //                                        vin_Line.FROM_JAN_VIN = Serial_number;
        //                                    }
        //                                    else
        //                                    {
        //                                        vin_Line.FROM_VIN = Serial_number;
        //                                    }
        //                                }
        //                                else
        //                                {

        //                                    vin_Line.FROM_VIN = Serial_number;
        //                                }
        //                            }
        //                            else if (country_type == "EXPORT")
        //                            {

        //                                if (exportNewYearVinNO)
        //                                {
        //                                    if (exportNewVinNoSeql)
        //                                    {
        //                                        vin_Line.FROM_JAN_VIN = Serial_number;
        //                                    }
        //                                    else { vin_Line.FROM_VIN = Serial_number; }
        //                                }
        //                                else { vin_Line.FROM_VIN = Serial_number; }
        //                            }
        //                            #endregion

        //                            //vin_Line.FROM_VIN = Serial_number;0
        //                            if (VinNo.Length < 17)
        //                            { }
        //                            else
        //                            {
        //                                db.Entry(vin_Line).State = EntityState.Modified;
        //                                db.SaveChanges();
        //                            }
        //                            //----------------------------------------------------------//
        //                        }
        //                    }
        //                    else
        //                    {
        //                        VinNo = null;
        //                    }
        //                }
        //                else
        //                {
        //                    VinNo = "DuplicateDeteced";
        //                }






        //                //if (to_VIN >= Serial_number)
        //                //{
        //                //    if (Serial_number != 0)
        //                //    {
        //                //        Serial_number = Serial_number + 1;
        //                //        VinNo += Serial_number;

        //                //        //---------------Update in FROM_VIN ------------------------//

        //                //        vin_Line = new MM_MAST_VIN_LINE();
        //                //        vin_Line = db.MM_MAST_VIN_LINE.Find(lineId);
        //                //        //domesticNewVinNoSeq
        //                //        //exportNewVinNoSeql
        //                //        #region 
        //                //        if (country_type == "DOMESTIC" || country_type == "")
        //                //        {

        //                //            if (domesticNewYearVinNo)
        //                //            {
        //                //                if (domesticNewVinNoSeq)
        //                //                {
        //                //                    vin_Line.FROM_JAN_VIN = Serial_number;
        //                //                }
        //                //                else
        //                //                { vin_Line.FROM_VIN = Serial_number; }
        //                //            }
        //                //            else { vin_Line.FROM_VIN = Serial_number; }
        //                //        }
        //                //        else if (country_type == "EXPORT")
        //                //        {

        //                //            if (exportNewYearVinNO)
        //                //            {
        //                //                if (exportNewVinNoSeql)
        //                //                {
        //                //                    vin_Line.FROM_JAN_VIN = Serial_number;
        //                //                }
        //                //                else { vin_Line.FROM_VIN = Serial_number; }
        //                //            }
        //                //            else { vin_Line.FROM_VIN = Serial_number; }
        //                //        }
        //                //        #endregion




        //                //        //vin_Line.FROM_VIN = Serial_number;0
        //                //        if (VinNo.Length < 17)
        //                //        {
        //                //        }
        //                //        else
        //                //        {
        //                //            db.Entry(vin_Line).State = EntityState.Modified;
        //                //            db.SaveChanges();
        //                //        }
        //                //        //----------------------------------------------------------//
        //                //    }
        //                //}
        //                //else
        //                //{
        //                //    VinNo = null;
        //                //}
        //            }
        //        }
        //        return VinNo;
        //    }
        //    catch (Exception ex)
        //    {
        //        Utility.Utility objUtility = new Utility.Utility();
        //        objUtility.AddDataToHelpDesk(4, 2, 3, 7, 1, 1, Convert.ToInt32(lineId), 59, "VMDT160052", 1, "Unable to generate Vin Number for Model Code " + ModelCode, ex.Message + ex.InnerException + " Stack " + ex.StackTrace);
        //        objUtility = null;
        //        return null;
        //    }
        //}


    }////







    public class MetaOrderStart
    {
        [DisplayFormat(DataFormatString = "{0:dd/MM/yyyy}")]
        public DateTime? Entry_Date { get; set; }

        [DisplayFormat(ApplyFormatInEditMode = true, DataFormatString = @"{0:hh\:mm}")]
        public TimeSpan? Entry_Time { get; set; }
    }
}
